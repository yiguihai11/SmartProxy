<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartProxy å†…å­˜ç›‘æ§</title>
    <script src="chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .header p {
            color: #718096;
            font-size: 1.1rem;
        }
        .controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #667eea;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }
        .stat-icon.blue { background: linear-gradient(135deg, #667eea, #764ba2); }
        .stat-icon.green { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .stat-icon.orange { background: linear-gradient(135deg, #fa709a, #fee140); }
        .stat-icon.red { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #718096;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stat-change {
            font-size: 0.85rem;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .stat-change.positive { color: #43e97b; }
        .stat-change.negative { color: #f56565; }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .chart-card h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .pools-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .pools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .pool-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }
        .pool-card h4 {
            color: #2d3748;
            margin-bottom: 15px;
        }
        .pool-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .pool-stat {
            text-align: center;
        }
        .pool-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
        }
        .pool-stat-label {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 5px;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .timestamp {
            text-align: center;
            color: #718096;
            font-size: 0.9rem;
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .control-group {
                flex-direction: column;
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§  SmartProxy å†…å­˜ç›‘æ§</h1>
            <p>å®æ—¶ç›‘æ§ç³»ç»Ÿå†…å­˜ä½¿ç”¨æƒ…å†µå’Œå¯¹è±¡æ± æ€§èƒ½</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <button class="btn" onclick="loadData()">
                    ğŸ”„ åˆ·æ–°æ•°æ®
                </button>
                <button class="btn btn-secondary" onclick="clearHistory()">
                    ğŸ—‘ï¸ æ¸…é™¤å†å²
                </button>
                <button class="btn btn-success" onclick="exportData()">
                    ğŸ“Š å¯¼å‡ºæ•°æ®
                </button>
            </div>
            <div class="auto-refresh">
                <label class="switch">
                    <input type="checkbox" id="autoRefresh" checked>
                    <span class="slider"></span>
                </label>
                <span>è‡ªåŠ¨åˆ·æ–° (5ç§’)</span>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">ğŸ’¾</div>
                <div class="stat-value" id="allocated-memory">-</div>
                <div class="stat-label">å·²åˆ†é…å†…å­˜</div>
                <div class="stat-change" id="memory-change">
                    <span>ğŸ“ˆ</span>
                    <span>-</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="memory-progress" style="width: 0%"></div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">ğŸ”—</div>
                <div class="stat-value" id="active-connections">-</div>
                <div class="stat-label">TCPè¿æ¥æ•°</div>
                <div class="stat-change positive">
                    <span>âœ“</span>
                    <span>æ­£å¸¸è¿è¡Œ</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon blue">ğŸ“¡</div>
                <div class="stat-value" id="udp-sessions">-</div>
                <div class="stat-label">UDPä¼šè¯æ•°</div>
                <div class="stat-change positive">
                    <span>ğŸ“Š</span>
                    <span>å®æ—¶æ›´æ–°</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange">ğŸ’¾</div>
                <div class="stat-value" id="dns-cache">-</div>
                <div class="stat-label">DNSç¼“å­˜æ•°</div>
                <div class="stat-change positive">
                    <span>ğŸ”„</span>
                    <span>è‡ªåŠ¨æ¸…ç†</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange">ğŸ—‘ï¸</div>
                <div class="stat-value" id="gc-count">-</div>
                <div class="stat-label">GC è¿è¡Œæ¬¡æ•°</div>
                <div class="stat-change" id="gc-change">
                    <span>â±ï¸</span>
                    <span>-</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon red">ğŸ“Š</div>
                <div class="stat-value" id="memory-pressure">-</div>
                <div class="stat-label">å†…å­˜å‹åŠ›</div>
                <div class="stat-change" id="pressure-status">
                    <span>â—</span>
                    <span>-</span>
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3>ğŸ“ˆ å†…å­˜ä½¿ç”¨è¶‹åŠ¿</h3>
                <div class="chart-container">
                    <canvas id="memoryChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>ğŸ“Š TCP/UDP/DNS å®æ—¶ç›‘æ§</h3>
                <div class="chart-container">
                    <canvas id="connectionsChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>â™»ï¸ å¯¹è±¡æ± æ•ˆç‡</h3>
                <div class="chart-container">
                    <canvas id="poolEfficiencyChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>ğŸ”„ ç¼“å†²åŒºåˆ†é…</h3>
                <div class="chart-container">
                    <canvas id="bufferAllocationChart"></canvas>
                </div>
            </div>
        </div>

        <div class="pools-section">
            <h3>ğŸ¯ å¯¹è±¡æ± è¯¦ç»†ç»Ÿè®¡</h3>
            <div class="pools-grid">
                <div class="pool-card">
                    <h4>ğŸ“¦ ç¼“å†²åŒºæ± </h4>
                    <div class="pool-stats">
                        <div class="pool-stat">
                            <div class="pool-stat-value" id="buffer-active">-</div>
                            <div class="pool-stat-label">æ´»è·ƒå¯¹è±¡</div>
                        </div>
                        <div class="pool-stat">
                            <div class="pool-stat-value" id="buffer-hit-rate">-</div>
                            <div class="pool-stat-label">å‘½ä¸­ç‡</div>
                        </div>
                        <div class="pool-stat">
                            <div class="pool-stat-value" id="buffer-total-requests">-</div>
                            <div class="pool-stat-label">æ€»è¯·æ±‚æ•°</div>
                        </div>
                        <div class="pool-stat">
                            <div class="pool-stat-value" id="buffer-memory">-</div>
                            <div class="pool-stat-label">å†…å­˜ä½¿ç”¨(MB)</div>
                        </div>
                    </div>
                </div>
                <div class="pool-card">
                    <h4>ğŸ”Œ è¿æ¥æ± </h4>
                    <div class="pool-stats">
                        <div class="pool-stat">
                            <div class="pool-stat-value" id="conn-active">-</div>
                            <div class="pool-stat-label">æ´»è·ƒè¿æ¥</div>
                        </div>
                        <div class="pool-stat">
                            <div class="pool-stat-value" id="conn-hit-rate">-</div>
                            <div class="pool-stat-label">å‘½ä¸­ç‡</div>
                        </div>
                        <div class="pool-stat">
                            <div class="pool-stat-value" id="conn-reuse-rate">-</div>
                            <div class="pool-stat-label">é‡ç”¨ç‡</div>
                        </div>
                        <div class="pool-stat">
                            <div class="pool-stat-value" id="conn-total">-</div>
                            <div class="pool-stat-label">æ€»è¯·æ±‚æ•°</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="timestamp" id="last-update">
            æœ€åæ›´æ–°: -
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let autoRefreshInterval;
        let memoryChart, connectionsChart, poolEfficiencyChart, bufferAllocationChart;
        let memoryHistory = [];
        let tcpHistory = [];
        let udpHistory = [];
        let dnsHistory = [];
        let previousStats = {};

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            // å†…å­˜ä½¿ç”¨è¶‹åŠ¿å›¾
            const memoryCtx = document.getElementById('memoryChart').getContext('2d');
            memoryChart = new Chart(memoryCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'å†…å­˜ä½¿ç”¨ (MB)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // è¿æ¥æ•°å˜åŒ–å›¾
            const connectionsCtx = document.getElementById('connectionsChart').getContext('2d');
            connectionsChart = new Chart(connectionsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'TCPè¿æ¥æ•°',
                            data: [],
                            borderColor: '#43e97b',
                            backgroundColor: 'rgba(67, 233, 123, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'UDPä¼šè¯æ•°',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'DNSç¼“å­˜æ•°',
                            data: [],
                            borderColor: '#f6ad55',
                            backgroundColor: 'rgba(246, 173, 85, 0.1)',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // å¯¹è±¡æ± æ•ˆç‡å›¾
            const poolEfficiencyCtx = document.getElementById('poolEfficiencyChart').getContext('2d');
            poolEfficiencyChart = new Chart(poolEfficiencyCtx, {
                type: 'doughnut',
                data: {
                    labels: ['ç¼“å†²åŒºæ± å‘½ä¸­ç‡', 'è¿æ¥æ± å‘½ä¸­ç‡'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#667eea', '#43e97b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // ç¼“å†²åŒºåˆ†é…å›¾
            const bufferAllocationCtx = document.getElementById('bufferAllocationChart').getContext('2d');
            bufferAllocationChart = new Chart(bufferAllocationCtx, {
                type: 'bar',
                data: {
                    labels: ['64B', '256B', '1KB', '4KB', '8KB', '16KB', '32KB', '64KB'],
                    datasets: [{
                        label: 'æ´»è·ƒå¯¹è±¡æ•°',
                        data: [0, 0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: '#764ba2'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
                const [memoryStats, memoryUsage, memoryEfficiency, poolsData] = await Promise.all([
                    fetch('/api/memory/stats').then(r => r.json()),
                    fetch('/api/memory/usage').then(r => r.json()),
                    fetch('/api/memory/efficiency').then(r => r.json()),
                    fetch('/api/memory/pools').then(r => r.json())
                ]);

                if (memoryStats.success) {
                    updateMemoryStats(memoryStats.data);
                }

                if (memoryUsage.success) {
                    updateMemoryUsage(memoryUsage.data);
                }

                if (memoryEfficiency.success) {
                    updateMemoryEfficiency(memoryEfficiency.data);
                }

                if (poolsData.success) {
                    updatePoolsData(poolsData.data);
                }

                // æ›´æ–°æ—¶é—´æˆ³
                document.getElementById('last-update').textContent =
                    `æœ€åæ›´æ–°: ${new Date().toLocaleString()}`;

                // æ›´æ–°å›¾è¡¨
                updateCharts();

            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showError('æ— æ³•åŠ è½½ç›‘æ§æ•°æ®');
            }
        }

        // æ›´æ–°å†…å­˜ç»Ÿè®¡
        function updateMemoryStats(stats) {
            const allocatedMB = (stats.alloc / 1024 / 1024).toFixed(2);
            document.getElementById('allocated-memory').textContent = allocatedMB;

            const activeConnections = stats.active_connections || 0;
            const activeUDPSessions = stats.active_udp_sessions || 0;
            const activeDNSCache = stats.active_dns_cache || 0;

            document.getElementById('active-connections').textContent = activeConnections;
            document.getElementById('udp-sessions').textContent = activeUDPSessions;
            document.getElementById('dns-cache').textContent = activeDNSCache;

            const gcCount = stats.num_gc || 0;
            document.getElementById('gc-count').textContent = gcCount;

            // è®¡ç®—å˜åŒ–
            if (previousStats.alloc) {
                const change = stats.alloc - previousStats.alloc;
                const changeElement = document.getElementById('memory-change');
                if (change > 0) {
                    changeElement.className = 'stat-change positive';
                    changeElement.innerHTML = `<span>ğŸ“ˆ</span><span>+${(change/1024/1024).toFixed(2)} MB</span>`;
                } else {
                    changeElement.className = 'stat-change negative';
                    changeElement.innerHTML = `<span>ğŸ“‰</span><span>${(change/1024/1024).toFixed(2)} MB</span>`;
                }
            }

            if (previousStats.num_gc) {
                const gcChange = stats.num_gc - previousStats.num_gc;
                document.getElementById('gc-change').innerHTML =
                    `<span>ğŸ”„</span><span>+${gcChange} æ¬¡</span>`;
            }

            previousStats = stats;

            // æ·»åŠ åˆ°å†å²è®°å½•
            const currentTime = new Date().toLocaleTimeString();
            memoryHistory.push({
                time: currentTime,
                value: parseFloat(allocatedMB)
            });

            tcpHistory.push({
                time: currentTime,
                value: activeConnections
            });

            udpHistory.push({
                time: currentTime,
                value: activeUDPSessions
            });

            dnsHistory.push({
                time: currentTime,
                value: activeDNSCache
            });

            // é™åˆ¶å†å²è®°å½•é•¿åº¦
            if (memoryHistory.length > 20) memoryHistory.shift();
            if (tcpHistory.length > 20) tcpHistory.shift();
            if (udpHistory.length > 20) udpHistory.shift();
            if (dnsHistory.length > 20) dnsHistory.shift();
        }

        // æ›´æ–°å†…å­˜ä½¿ç”¨
        function updateMemoryUsage(usage) {
            const systemMemory = usage.system_memory;
            if (systemMemory) {
                const totalMB = (systemMemory.system_bytes / 1024 / 1024).toFixed(0);
                const allocatedMB = (systemMemory.allocated_bytes / 1024 / 1024).toFixed(0);
                const percentage = (allocatedMB / totalMB * 100).toFixed(1);

                document.getElementById('memory-progress').style.width = percentage + '%';
            }
        }

        // æ›´æ–°å†…å­˜æ•ˆç‡
        function updateMemoryEfficiency(efficiency) {
            const pressure = efficiency.memory_pressure || 'unknown';
            const pressureElement = document.getElementById('memory-pressure');
            const statusElement = document.getElementById('pressure-status');

            switch(pressure) {
                case 'low':
                    pressureElement.textContent = 'ä½';
                    statusElement.innerHTML = `<span style="color: #43e97b">â—</span><span>æ­£å¸¸</span>`;
                    break;
                case 'medium':
                    pressureElement.textContent = 'ä¸­';
                    statusElement.innerHTML = `<span style="color: #f6ad55">â—</span><span>æ³¨æ„</span>`;
                    break;
                case 'high':
                    pressureElement.textContent = 'é«˜';
                    statusElement.innerHTML = `<span style="color: #f56565">â—</span><span>è­¦å‘Š</span>`;
                    break;
                default:
                    pressureElement.textContent = 'æœªçŸ¥';
                    statusElement.innerHTML = `<span style="color: #718096">â—</span><span>æœªçŸ¥</span>`;
            }
        }

        // æ›´æ–°å¯¹è±¡æ± æ•°æ®
        function updatePoolsData(pools) {
            // è°ƒè¯•è¾“å‡º
            console.log('Pool Data:', pools);

            if (pools.buffer_pool) {
                const bufferPool = pools.buffer_pool;
                document.getElementById('buffer-active').textContent = bufferPool.active_objects || 0;
                document.getElementById('buffer-hit-rate').textContent =
                    (bufferPool.hit_rate_percent || 0).toFixed(1) + '%';
                document.getElementById('buffer-total-requests').textContent =
                    (bufferPool.total_requests || 0).toLocaleString();
                document.getElementById('buffer-memory').textContent =
                    (bufferPool.total_memory_mb || 0).toFixed(1);

                console.log('Buffer Pool:', bufferPool);
            }

            if (pools.connection_pool) {
                const connectionPool = pools.connection_pool;
                console.log('Connection Pool:', connectionPool);

                // æ ¹æ®å®é™…çš„APIå“åº”è°ƒæ•´å­—æ®µå
                document.getElementById('conn-active').textContent =
                    connectionPool.active_connections || connectionPool.active_objects || 0;
                document.getElementById('conn-hit-rate').textContent =
                    (connectionPool.hit_rate_percent || 0).toFixed(1) + '%';
                document.getElementById('conn-reuse-rate').textContent =
                    (connectionPool.reuse_rate_percent || 0).toFixed(1) + '%';
                document.getElementById('conn-total').textContent =
                    (connectionPool.total_requests || 0).toLocaleString();
            }
        }

        // æ›´æ–°å›¾è¡¨
        function updateCharts() {
            // æ›´æ–°å†…å­˜è¶‹åŠ¿å›¾
            if (memoryHistory.length > 0) {
                memoryChart.data.labels = memoryHistory.map(h => h.time);
                memoryChart.data.datasets[0].data = memoryHistory.map(h => h.value);
                memoryChart.update();
            }

            // æ›´æ–°è¿æ¥æ•°å›¾è¡¨
            if (tcpHistory.length > 0) {
                connectionsChart.data.labels = tcpHistory.map(h => h.time);
                connectionsChart.data.datasets[0].data = tcpHistory.map(h => h.value);
                connectionsChart.data.datasets[1].data = udpHistory.map(h => h.value);
                connectionsChart.data.datasets[2].data = dnsHistory.map(h => h.value);
                connectionsChart.update();
            }

            // æ›´æ–°å¯¹è±¡æ± æ•ˆç‡å›¾ï¼ˆç¤ºä¾‹æ•°æ®ï¼‰
            const bufferHitRate = parseFloat(document.getElementById('buffer-hit-rate').textContent) || 0;
            const connHitRate = parseFloat(document.getElementById('conn-hit-rate').textContent) || 0;
            poolEfficiencyChart.data.datasets[0].data = [bufferHitRate, connHitRate];
            poolEfficiencyChart.update();
        }

        // è‡ªåŠ¨åˆ·æ–°æ§åˆ¶
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            if (checkbox.checked) {
                autoRefreshInterval = setInterval(loadData, 5000);
            } else {
                clearInterval(autoRefreshInterval);
            }
        }

        // æ¸…é™¤å†å²
        function clearHistory() {
            memoryHistory = [];
            connectionsHistory = [];
            updateCharts();
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const data = {
                timestamp: new Date().toISOString(),
                memory_history: memoryHistory,
                connections_history: connectionsHistory,
                current_stats: previousStats
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `smartproxy-memory-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.controls'));
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadData();

            // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
            document.getElementById('autoRefresh').addEventListener('change', toggleAutoRefresh);
            toggleAutoRefresh();
        });
    </script>
</body>
</html>