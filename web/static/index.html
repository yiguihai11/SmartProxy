<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>SmartProxy 管理面板</title>
    <link href="layui-v2.13.1/layui/css/layui.css" rel="stylesheet">
    <style>
        :root {
            --sidebar-width: 240px;
            --sidebar-mini-width: 65px;
            --primary-blue: #1677ff;
            --dark-navy: #001529;
            --bg-gray: #f0f2f5;
            --success-green: #52c41a;
            --warning-yellow: #faad14;
            --error-red: #ff4d4f;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        html, body { height: 100%; margin: 0; padding: 0; background: var(--bg-gray); }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif; overflow-x: hidden; }

        /* 侧边栏 */
        .side-nav { width: var(--sidebar-width); height: 100%; position: fixed; background: var(--dark-navy); color: #fff; transition: var(--transition); z-index: 1100; overflow-y: auto; }
        body.sidebar-mini .side-nav { width: var(--sidebar-mini-width); }
        body.sidebar-mini .logo-box h1, body.sidebar-mini .nav-item span { display: none; }
        .logo-box { padding: 20px; background: #002140; text-align: center; white-space: nowrap; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .logo-box h1 { font-size: 18px; margin: 0; color: #fff; letter-spacing: 1px; }
        .nav-item { padding: 16px 22px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: rgba(255,255,255,0.7); transition: background 0.2s; }
        .nav-item:hover, .nav-item.active { background: var(--primary-blue); color: #fff; }

        /* 主容器 */
        .main-container { margin-left: var(--sidebar-width); transition: var(--transition); display: flex; flex-direction: column; min-height: 100vh; }
        body.sidebar-mini .main-container { margin-left: var(--sidebar-mini-width); }
        
        .app-header { background: #fff; height: 60px; display: flex; align-items: center; padding: 0 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .header-logo-text { font-size: 12px; color: #666; margin-left: 10px; }

        /* 状态指示灯 */
        .status-area { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #666; margin-left: auto; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--success-green); box-shadow: 0 0 8px var(--success-green); animation: breathe 2s infinite ease-in-out; }
        @keyframes breathe { 0%, 100% { opacity: 0.4; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.1); } }

        /* 内容区 */
        .content-body { padding: 20px; flex: 1 0 auto; } 
        .card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 15px; }
        .card-title { font-weight: bold; margin-bottom: 20px; font-size: 16px; color: #333; border-left: 4px solid var(--primary-blue); padding-left: 10px; }
        .stat-card { text-align: center; }
        .stat-label { font-size: 12px; color: #999; margin-bottom: 5px; }
        .stat-value { font-size: 28px; font-weight: bold; color: var(--primary-blue); }
        .chart-box { height: 280px; width: 100%; }

        /* 表单样式 */
        .layui-form-switch { height: 26px; line-height: 26px; margin-top: 0; min-width: 55px; }
        .layui-form-switch i { top: 3px; width: 18px; height: 18px; }
        .layui-form-switch em { top: 0 !important; line-height: 26px !important; height: 26px !important; font-style: normal; }

        /* 端口验证 */
        .port-tip { visibility: hidden; opacity: 0; transition: 0.2s; font-size: 12px; margin-left: 10px; }
        .port-tip.show { visibility: visible; opacity: 1; }
        .port-warning.layui-input { border-color: var(--warning-yellow) !important; }
        .port-error.layui-input { border-color: var(--error-red) !important; }
        .text-warning { color: var(--warning-yellow) !important; }
        .text-error { color: var(--error-red) !important; }

        /* 标签样式 */
        .tag { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 12px; margin-right: 5px; }
        .tag-success { background: #f0f9ff; color: #1677ff; border: 1px solid #d0e7ff; }
        .tag-warning { background: #fffbe6; color: #faad14; border: 1px solid #ffe58f; }
        .tag-error { background: #fff1f0; color: #ff4d4f; border: 1px solid #ffccc7; }

        /* 页脚 */
        .app-footer { flex-shrink: 0; padding: 25px 20px; text-align: center; border-top: 1px solid rgba(0,0,0,0.05); background: #fff; }
        .footer-slogan { font-size: 11px; color: #aaa; margin-bottom: 5px; }
        .footer-copyright { font-size: 13px; color: #777; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .github-btn { color: #666; text-decoration: none; transition: color 0.2s; font-size: 20px; }
        .github-btn:hover { color: var(--primary-blue); }

        /* 页面切换 */
        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 响应式 */
        @media screen and (max-width: 768px) {
            .side-nav { transform: translateX(-100%); }
            .side-nav.mobile-open { transform: translateX(0); width: var(--sidebar-width) !important; }
            .main-container { margin-left: 0 !important; }
            #mask { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1050; }
            #mask.show { display: block; }
        }

        /* 配置项样式 */
        .config-group { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px dashed #eee; }
        .config-group:last-child { border-bottom: none; }
        .sub-title { font-size: 14px; color: #666; margin-bottom: 15px; font-weight: 500; }

        /* 密码显示/隐藏样式 */
        .password-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #999;
            font-size: 16px;
            z-index: 10;
            background: white;
            padding: 0 5px;
        }
        .password-toggle:hover {
            color: #666;
        }
        .layui-input-block .password-wrapper input,
        .layui-input-inline .password-wrapper input {
            padding-right: 35px;
        }

        /* DNS 服务器列表样式 */
        .dns-list {
            padding: 10px 0;
        }
        .dns-item {
            display: flex;
            margin-bottom: 8px;
            align-items: center;
        }
        .dns-item input {
            flex: 1;
            margin-right: 10px;
        }
        .dns-item .layui-btn {
            margin: 0;
        }
        .dns-item .add-btn,
        .dns-item .remove-btn {
            background-color: transparent;
            color: #666;
            border: none;
            padding: 0;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
        }
        .dns-item .add-btn {
            color: #009688;
        }
        .dns-item .remove-btn {
            color: #FF5722;
        }
        .dns-item .add-btn:hover {
            color: #00796b;
        }
        .dns-item .remove-btn:hover {
            color: #d84315;
        }
        .dns-item .add-btn.layui-btn-disabled,
        .dns-item .remove-btn.layui-btn-disabled {
            color: #e6e6e6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

<div id="mask"></div>

<aside class="side-nav" id="sidebar">
    <div class="logo-box"><h1>SmartProxy</h1></div>
    <div class="nav-item" data-page="home" data-label="运行状态"><i class="layui-icon layui-icon-home"></i> <span>运行状态</span></div>
    <div class="nav-item" onclick="window.open('/memory.html', '_blank')" data-label="内存监控"><i class="layui-icon layui-icon-chart"></i> <span>内存监控</span></div>
    <div class="nav-item" data-page="listener" data-label="监听配置"><i class="layui-icon layui-icon-set"></i> <span>监听配置</span></div>
    <div class="nav-item" data-page="socks5" data-label="SOCKS5 配置"><i class="layui-icon layui-icon-username"></i> <span>SOCKS5 配置</span></div>
    <div class="nav-item" data-page="router" data-label="路由规则"><i class="layui-icon layui-icon-share"></i> <span>路由规则</span></div>
    <div class="nav-item" data-page="dns" data-label="DNS 配置"><i class="layui-icon layui-icon-website"></i> <span>DNS 配置</span></div>
    <div class="nav-item" data-page="nat" data-label="NAT 穿透"><i class="layui-icon layui-icon-transfer"></i> <span>NAT 穿透</span></div>
    <div class="nav-item" data-page="logging" data-label="日志配置"><i class="layui-icon layui-icon-file"></i> <span>日志配置</span></div>
</aside>

<main class="main-container">
    <header class="app-header">
        <i class="layui-icon layui-icon-spread-left" id="toggleBtn" style="font-size: 22px; cursor: pointer; color: var(--primary-blue);"></i>
        <div id="title-display" style="margin-left:15px; font-weight: 500; font-size: 16px;">运行状态</div>
        <div class="status-area">
            <span style="color: var(--success-green);">正常运行</span>
            <span class="status-dot"></span>
        </div>
    </header>
    
    <div class="content-body">
        <!-- 运行状态 -->
        <section id="page-home" class="page-section active">
            <div class="layui-row layui-col-space15">
                <div class="layui-col-md6 layui-col-xs12">
                    <div class="card stat-card">
                        <div class="stat-label">上行速度</div>
                        <div class="stat-value" id="up-speed" style="color: var(--success-green);">0</div>
                        <div class="stat-label">KB/s</div>
                    </div>
                </div>
                <div class="layui-col-md6 layui-col-xs12">
                    <div class="card stat-card">
                        <div class="stat-label">下行速度</div>
                        <div class="stat-value" id="down-speed">0</div>
                        <div class="stat-label">KB/s</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">流量监控</div>
                <div class="chart-box"><canvas id="trafficChart"></canvas></div>
            </div>
        </section>

        <!-- 监听配置 -->
        <section id="page-listener" class="page-section">
            <div class="card">
                <div class="card-title">监听端口配置</div>
                <form class="layui-form" lay-filter="listenerForm">
                    <div class="layui-form-item">
                        <label class="layui-form-label">SOCKS5 端口</label>
                        <div class="layui-input-inline">
                            <input type="number" name="socks5_port" class="layui-input port-input" placeholder="1080" min="1" max="65535" step="1">
                        </div>
                        <div class="layui-form-mid port-tip"></div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">Web 管理端口</label>
                        <div class="layui-input-inline">
                            <input type="number" name="web_port" class="layui-input port-input" placeholder="8080" min="1" max="65535" step="1">
                        </div>
                        <div class="layui-form-mid port-tip"></div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">DNS 端口</label>
                        <div class="layui-input-inline">
                            <input type="number" name="dns_port" class="layui-input port-input" placeholder="1053" min="1" max="65535" step="1">
                        </div>
                        <div class="layui-form-mid port-tip"></div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">IPv6 支持</label>
                        <div class="layui-input-block">
                            <input type="checkbox" name="ipv6_enabled" lay-skin="switch" lay-text="开启|关闭">
                        </div>
                    </div>
                    <div class="layui-form-item" style="padding-left: 110px; margin-top: 25px;">
                        <button type="button" class="layui-btn layui-btn-normal" id="saveListener">
                            <i class="layui-icon layui-icon-ok"></i> 保存配置
                        </button>
                        <button type="button" class="layui-btn layui-btn-primary" id="reloadConfig">
                            <i class="layui-icon layui-icon-refresh"></i> 重新加载
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- SOCKS5 配置 -->
        <section id="page-socks5" class="page-section">
            <div class="card">
                <div class="card-title">SOCKS5 认证配置</div>
                <form class="layui-form" lay-filter="socks5Form">
                    <div class="layui-form-item">
                        <label class="layui-form-label">启用认证</label>
                        <div class="layui-input-block">
                            <input type="checkbox" name="enable_auth" lay-skin="switch" lay-text="开启|关闭" lay-filter="authSwitch">
                        </div>
                    </div>
                </form>
            </div>

            <div class="card" id="authUsersCard" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="card-title" style="margin-bottom: 0;">认证用户列表</div>
                    <button type="button" class="layui-btn layui-btn-sm" id="addUserBtn">
                        <i class="layui-icon layui-icon-add-circle"></i> 新增用户
                    </button>
                </div>
                <table id="userTable" lay-filter="userTable"></table>
            </div>
        </section>

        <!-- 路由规则 -->
        <section id="page-router" class="page-section">
            <div class="card">
                <div class="card-title">智能代理配置</div>
                <form class="layui-form" lay-filter="smartProxyForm">
                    <div class="layui-form-item">
                        <label class="layui-form-label">启用智能代理</label>
                        <div class="layui-input-block">
                            <input type="checkbox" name="smart_proxy_enabled" lay-skin="switch" lay-text="开启|关闭">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">超时时间 (ms)</label>
                        <div class="layui-input-inline">
                            <input type="number" name="timeout_ms" class="layui-input" placeholder="1500">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">黑名单过期 (分钟)</label>
                        <div class="layui-input-inline">
                            <input type="number" name="blacklist_expiry_minutes" class="layui-input" placeholder="360">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">探测端口</label>
                        <div class="layui-input-block">
                            <div id="probing-ports-list" class="dns-list">
                                <!-- 探测端口项将通过 JavaScript 动态添加 -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="card">
                <div class="card-title">CHNRoutes</div>
                <form class="layui-form" lay-filter="chnroutesForm">
                    <div class="layui-form-item">
                        <label class="layui-form-label">启用 CHNRoutes</label>
                        <div class="layui-input-block">
                            <input type="checkbox" name="chnroutes_enabled" lay-skin="switch" lay-text="开启|关闭">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">CHNRoutes 路径</label>
                        <div class="layui-input-inline">
                            <input type="text" name="chnroutes_path" class="layui-input" placeholder="conf/chnroutes.txt">
                        </div>
                    </div>
                </form>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="card-title" style="margin-bottom: 0;">路由规则</div>
                    <button type="button" class="layui-btn layui-btn-sm" id="addRuleBtn">
                        <i class="layui-icon layui-icon-add-circle"></i> 新增规则
                    </button>
                </div>
                <table id="rulesTable" lay-filter="rulesTable"></table>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="card-title" style="margin-bottom: 0;">代理节点</div>
                    <button type="button" class="layui-btn layui-btn-sm" id="addNodeBtn">
                        <i class="layui-icon layui-icon-add-circle"></i> 新增节点
                    </button>
                </div>
                <table id="nodesTable" lay-filter="nodesTable"></table>
            </div>

            <div class="layui-form-item" style="padding-left: 10px; margin-top: 25px;">
                <button type="button" class="layui-btn layui-btn-normal" id="saveRouterConfig">
                    <i class="layui-icon layui-icon-ok"></i> 保存路由配置
                </button>
            </div>
        </section>

        <!-- DNS 配置 -->
        <section id="page-dns" class="page-section">
            <div class="card">
                <div class="card-title">DNS 服务配置</div>
                <form class="layui-form" lay-filter="dnsForm">
                    <div class="layui-form-item">
                        <label class="layui-form-label">启用 DNS</label>
                        <div class="layui-input-block">
                            <input type="checkbox" name="dns_enabled" lay-skin="switch" lay-text="开启|关闭">
                        </div>
                    </div>
                    <div class="config-group">
                        <div class="sub-title">缓存配置</div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">最大缓存数</label>
                            <div class="layui-input-inline">
                                <input type="number" name="cache_max_size" class="layui-input" placeholder="2000">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">默认 TTL (秒)</label>
                            <div class="layui-input-inline">
                                <input type="number" name="cache_default_ttl" class="layui-input" placeholder="300">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">清理间隔 (秒)</label>
                            <div class="layui-input-inline">
                                <input type="number" name="cache_cleanup_interval" class="layui-input" placeholder="60">
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="card">
                <div class="card-title">DNS 服务器组</div>
                <form class="layui-form" lay-filter="dnsGroupsForm">
                     <div class="layui-form-item">
                        <label class="layui-form-label">国内 DNS</label>
                        <div class="layui-input-block">
                            <div id="dns-cn-list" class="dns-list">
                                <!-- DNS 项将通过 JavaScript 动态添加 -->
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">国外 DNS</label>
                        <div class="layui-input-block">
                            <div id="dns-foreign-list" class="dns-list">
                                <!-- DNS 项将通过 JavaScript 动态添加 -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="card-title" style="margin-bottom: 0;">DNS 劫持规则</div>
                    <button type="button" class="layui-btn layui-btn-sm" id="addHijackBtn">
                        <i class="layui-icon layui-icon-add-circle"></i> 新增规则
                    </button>
                </div>
                <table id="hijackTable" lay-filter="hijackTable"></table>
            </div>

            <div class="layui-form-item" style="padding-left: 10px; margin-top: 25px;">
                <button type="button" class="layui-btn layui-btn-normal" id="saveDnsConfig">
                    <i class="layui-icon layui-icon-ok"></i> 保存DNS配置
                </button>
            </div>
        </section>

        <!-- NAT 穿透 -->
        <section id="page-nat" class="page-section">
            <div class="card">
                <div class="card-title">NAT 穿透配置</div>
                <form class="layui-form" lay-filter="natForm">
                    <div class="layui-form-item">
                        <label class="layui-form-label">启用 NAT 穿透</label>
                        <div class="layui-input-block">
                            <input type="checkbox" name="nat_enabled" lay-filter="nat_enabled" lay-skin="switch" lay-text="开启|关闭">
                        </div>
                    </div>
                    <div id="nat-config-items">
                    <div class="layui-form-item">
                        <label class="layui-form-label">模式</label>
                        <div class="layui-input-inline">
                            <select name="nat_mode">
                                <option value="auto">自动</option>
                                <option value="stun">STUN</option>
                                <option value="turn">TURN</option>
                                <option value="upnp">UPnP</option>
                                <option value="holepunch">UDP打洞</option>
                            </select>
                        </div>
                    </div>
                    <!-- 通用设置 -->
                    <div class="layui-form-item">
                        <label class="layui-form-label">保活间隔 (秒)</label>
                        <div class="layui-input-inline">
                            <input type="number" name="keepalive_interval" class="layui-input" placeholder="30">
                        </div>
                    </div>

                    <!-- STUN 设置 -->
                    <div class="nat-settings-group" data-modes="stun,auto" style="border-top: 1px solid #f0f0f0; padding-top: 15px; margin-top: 15px;">
                        <div style="color: #666; font-size: 12px; margin-bottom: 10px; padding-left: 10px;">
                            <i class="layui-icon layui-icon-tips"></i> STUN协议配置
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">STUN 服务器</label>
                            <div class="layui-input-block">
                                <textarea name="stun_servers" class="layui-textarea" placeholder="每行一个STUN服务器"></textarea>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">STUN 超时 (秒)</label>
                            <div class="layui-input-inline">
                                <input type="number" name="stun_timeout" class="layui-input" placeholder="5">
                            </div>
                        </div>
                    </div>

                    <!-- TURN 设置 -->
                    <div class="nat-settings-group" data-modes="turn,auto" style="border-top: 1px solid #f0f0f0; padding-top: 15px; margin-top: 15px;">
                        <div style="color: #666; font-size: 12px; margin-bottom: 10px; padding-left: 10px;">
                            <i class="layui-icon layui-icon-tips"></i> TURN中继服务器配置
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">TURN 服务器</label>
                            <div class="layui-input-inline">
                                <input type="text" name="turn_server" class="layui-input" placeholder="e.g., turn.example.com:3478">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">TURN 用户名</label>
                            <div class="layui-input-inline">
                                <input type="text" name="turn_username" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">TURN 密码</label>
                            <div class="layui-input-inline">
                                <div class="password-wrapper">
                                    <input type="password" name="turn_password" class="layui-input">
                                    <i class="layui-icon layui-icon-eye password-toggle"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- UPnP 设置 -->
                    <div class="nat-settings-group" data-modes="upnp,auto" style="border-top: 1px solid #f0f0f0; padding-top: 15px; margin-top: 15px;">
                        <div style="color: #666; font-size: 12px; margin-bottom: 10px; padding-left: 10px;">
                            <i class="layui-icon layui-icon-tips"></i> UPnP端口映射配置
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">启用 UPnP</label>
                            <div class="layui-input-block">
                                <input type="checkbox" name="upnp_enabled" lay-skin="switch" lay-text="开启|关闭">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">端口范围</label>
                            <div class="layui-input-inline" style="width: 100px;">
                                <input type="number" name="port_start" class="layui-input" placeholder="Start">
                            </div>
                            <div class="layui-form-mid">-</div>
                            <div class="layui-input-inline" style="width: 100px;">
                                <input type="number" name="port_end" class="layui-input" placeholder="End">
                            </div>
                        </div>
                    </div>

                    <!-- 打洞设置 -->
                    <div class="nat-settings-group" data-modes="holepunch,auto" style="border-top: 1px solid #f0f0f0; padding-top: 15px; margin-top: 15px;">
                        <div style="color: #666; font-size: 12px; margin-bottom: 10px; padding-left: 10px;">
                            <i class="layui-icon layui-icon-tips"></i> UDP打洞模式配置
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">打洞次数</label>
                            <div class="layui-input-inline">
                                <input type="number" name="hole_punch_count" class="layui-input" placeholder="3">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">打洞延时 (ms)</label>
                            <div class="layui-input-inline">
                                <input type="number" name="hole_punch_delay" class="layui-input" placeholder="100">
                            </div>
                        </div>
                    </div>
                    </div>
                    <div class="layui-form-item" style="padding-left: 110px; margin-top: 25px;">
                        <button type="button" class="layui-btn layui-btn-normal" id="saveNatConfig">
                            <i class="layui-icon layui-icon-ok"></i> 保存NAT配置
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- 日志配置 -->
        <section id="page-logging" class="page-section">
            <div class="card">
                <div class="card-title">日志配置</div>
                <form class="layui-form" lay-filter="loggingForm">
                    <div class="layui-form-item">
                        <label class="layui-form-label">日志级别</label>
                        <div class="layui-input-inline">
                            <select name="log_level">
                                <option value="debug">Debug</option>
                                <option value="info">Info</option>
                                <option value="warn">Warn</option>
                                <option value="error">Error</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">输出文件</label>
                        <div class="layui-input-inline">
                            <input type="text" name="output_file" class="layui-input" placeholder="留空则输出到控制台">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">启用时间戳</label>
                        <div class="layui-input-block">
                            <input type="checkbox" name="enable_time" lay-skin="switch" lay-text="开启|关闭">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">启用颜色</label>
                        <div class="layui-input-block">
                            <input type="checkbox" name="enable_colors" lay-skin="switch" lay-text="开启|关闭">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">日志前缀</label>
                        <div class="layui-input-inline">
                            <input type="text" name="prefix" class="layui-input" placeholder="可选前缀">
                        </div>
                    </div>
                    <div class="layui-form-item" style="padding-left: 110px; margin-top: 25px;">
                        <button type="button" class="layui-btn layui-btn-normal" id="saveLogging">
                            <i class="layui-icon layui-icon-ok"></i> 保存配置
                        </button>
                    </div>
                </form>
            </div>
        </section>
    </div>

    <footer class="app-footer">
        <div class="footer-slogan">智能代理，安全上网</div>
        <div class="footer-copyright">
            <span>&copy; <span id="year"></span> SmartProxy Control Panel</span>
            <a href="https://github.com/yiguihai11/SmartProxy" target="_blank" class="github-btn" title="查看 GitHub 项目">
                <i class="layui-icon layui-icon-github"></i>
            </a>
        </div>
    </footer>
</main>

<script src="chart.umd.min.js"></script>
<script src="layui-v2.13.1/layui/layui.js"></script>

<script>
// ==================== SmartProxy 管理面板主程序 ====================
layui.use(['form', 'table', 'layer', 'laydate'], function(){
    const $ = layui.$;
    const form = layui.form;
    const table = layui.table;
    const layer = layui.layer;
    const laydate = layui.laydate;

    $('#year').text(new Date().getFullYear());

    // ==================== 密码显示/隐藏功能 ====================

    // 时间数组全局变量
    let allowedHoursArray = [];

    // 添加时间段
    window.addTimeSlot = function(btn) {
        // 使用原生方法查找容器
        let parentDiv = btn.parentElement;
        while (parentDiv) {
            if (parentDiv.classList && parentDiv.classList.contains('layui-input-block')) {
                break;
            }
            parentDiv = parentDiv.parentElement;
        }

        let container = parentDiv ? parentDiv.querySelector('#allowed-hours-list') : null;
        if (!container) {
            console.error('Container not found!');
            return;
        }

        const index = container.children.length;
        const timeSlotHtml = `
            <div class="time-slot-item" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;" data-index="${index}">
                <input type="text" class="layui-input time-start" placeholder="开始时间" readonly style="width: 35%;">
                <span style="color: #666;">至</span>
                <input type="text" class="layui-input time-end" placeholder="结束时间" readonly style="width: 35%;">
                <button type="button" class="layui-btn layui-btn-danger layui-btn-xs" onclick="removeTimeItem(this)">
                    <i class="layui-icon layui-icon-close"></i>
                </button>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', timeSlotHtml);

        // 初始化时间选择器
        layui.use('laydate', function(){
            const laydate = layui.laydate;

            const startInput = container.querySelector(`[data-index="${index}"] .time-start`);
            const endInput = container.querySelector(`[data-index="${index}"] .time-end`);

            if (startInput) {
                laydate.render({
                    elem: startInput,
                    type: 'time',
                    format: 'HH:mm'
                });
            }

            if (endInput) {
                laydate.render({
                    elem: endInput,
                    type: 'time',
                    format: 'HH:mm'
                });
            }
        });
    };

    // 添加单个小时
    window.addSingleHour = function(btn) {
        // 使用原生方法查找容器
        let parentDiv = btn.parentElement;
        while (parentDiv) {
            if (parentDiv.classList && parentDiv.classList.contains('layui-input-block')) {
                break;
            }
            parentDiv = parentDiv.parentElement;
        }

        let container = parentDiv ? parentDiv.querySelector('#allowed-hours-list') : null;
        if (!container) {
            console.error('Container not found!');
            return;
        }

        const index = container.children.length;
        const hourHtml = `
            <div class="hour-item" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;" data-index="${index}">
                <input type="number" class="layui-input single-hour" placeholder="小时 (0-23)" min="0" max="23" style="width: 30%;">
                <span style="color: #666;">点</span>
                <button type="button" class="layui-btn layui-btn-danger layui-btn-xs" onclick="removeTimeItem(this)">
                    <i class="layui-icon layui-icon-close"></i>
                </button>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', hourHtml);
    };

    // 删除时间项
    window.removeTimeItem = function(btn) {
        const item = btn.closest('.time-slot-item') || btn.closest('.hour-item');
        if (item) {
            item.remove();
        }
    };

    // 星期选择辅助函数
    window.selectAllDays = function() {
        const checkboxes = document.querySelectorAll('input[name^="allowed_days_"]');
        checkboxes.forEach(cb => cb.checked = true);
        layui.form.render('checkbox');
    };

    window.selectWeekdays = function() {
        const checkboxes = document.querySelectorAll('input[name^="allowed_days_"]');
        checkboxes.forEach(cb => cb.checked = false);

        const weekdays = ['allowed_days_monday', 'allowed_days_tuesday', 'allowed_days_wednesday', 'allowed_days_thursday', 'allowed_days_friday'];
        weekdays.forEach(name => {
            const cb = document.querySelector(`input[name="${name}"]`);
            if (cb) cb.checked = true;
        });
        layui.form.render('checkbox');
    };

    window.selectWeekends = function() {
        const checkboxes = document.querySelectorAll('input[name^="allowed_days_"]');
        checkboxes.forEach(cb => cb.checked = false);

        const weekend = ['allowed_days_saturday', 'allowed_days_sunday'];
        weekend.forEach(name => {
            const cb = document.querySelector(`input[name="${name}"]`);
            if (cb) cb.checked = true;
        });
        layui.form.render('checkbox');
    };

    window.clearAllDays = function() {
        const checkboxes = document.querySelectorAll('input[name^="allowed_days_"]');
        checkboxes.forEach(cb => cb.checked = false);
        layui.form.render('checkbox');
    };

    // 收集选中的星期
    function collectAllowedDays() {
        const days = [];
        const dayMap = {
            'allowed_days_monday': 'monday',
            'allowed_days_tuesday': 'tuesday',
            'allowed_days_wednesday': 'wednesday',
            'allowed_days_thursday': 'thursday',
            'allowed_days_friday': 'friday',
            'allowed_days_saturday': 'saturday',
            'allowed_days_sunday': 'sunday'
        };

        Object.keys(dayMap).forEach(checkboxName => {
            const cb = document.querySelector(`input[name="${checkboxName}"]`);
            if (cb && cb.checked) {
                days.push(dayMap[checkboxName]);
            }
        });

        return days;
    }

    // 收集所有时间配置
    function collectAllowedHours() {
        const container = document.getElementById('allowed-hours-list');
        if (!container) return [];

        const hours = [];

        // 收集时间段
        const timeSlots = container.querySelectorAll('.time-slot-item');
        timeSlots.forEach(item => {
            const start = item.querySelector('.time-start');
            const end = item.querySelector('.time-end');
            if (start && end && start.value && end.value) {
                hours.push(`${start.value}-${end.value}`);
            }
        });

        // 收集单个小时
        const hourItems = container.querySelectorAll('.hour-item');
        hourItems.forEach(item => {
            const hour = item.querySelector('.single-hour');
            if (hour && hour.value !== '') {
                hours.push(parseInt(hour.value));
            }
        });

        return hours;
    }

    // 初始化现有时间配置
    function initAllowedHours(hours) {
        const container = document.getElementById('allowed-hours-list');
        if (!container) return;

        container.innerHTML = '';
        allowedHoursArray = hours || [];

        let index = 0;
        allowedHoursArray.forEach(hour => {
            if (typeof hour === 'string' && hour.includes('-')) {
                // 时间段
                const [start, end] = hour.split('-');
                const timeSlotHtml = `
                    <div class="time-slot-item" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;" data-index="${index}">
                        <input type="text" class="layui-input time-start" value="${start}" placeholder="开始时间" readonly style="width: 35%;">
                        <span style="color: #666;">至</span>
                        <input type="text" class="layui-input time-end" value="${end}" placeholder="结束时间" readonly style="width: 35%;">
                        <button type="button" class="layui-btn layui-btn-danger layui-btn-xs" onclick="removeTimeItem(this)">
                            <i class="layui-icon layui-icon-close"></i>
                        </button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', timeSlotHtml);
            } else if (typeof hour === 'number') {
                // 单个小时
                const hourHtml = `
                    <div class="hour-item" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;" data-index="${index}">
                        <input type="number" class="layui-input single-hour" value="${hour}" placeholder="小时 (0-23)" min="0" max="23" style="width: 30%;">
                        <span style="color: #666;">点</span>
                        <button type="button" class="layui-btn layui-btn-danger layui-btn-xs" onclick="removeTimeItem(this)">
                            <i class="layui-icon layui-icon-close"></i>
                        </button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', hourHtml);
            }
            index++;
        });

        // 初始化时间选择器
        layui.use('laydate', function(){
            const laydate = layui.laydate;

            container.querySelectorAll('.time-start, .time-end').forEach(function(input) {
                laydate.render({
                    elem: input,
                    type: 'time',
                    format: 'HH:mm'
                });
            });
        });
    }
    // 使用事件委托处理动态添加的密码框
    $(document).on('click', '.password-toggle', function() {
        const $icon = $(this);
        const $input = $icon.siblings('input');
        const type = $input.attr('type');

        if (type === 'password') {
            $input.attr('type', 'text');
            $icon.removeClass('layui-icon-eye').addClass('layui-icon-eye-invisible');
        } else {
            $input.attr('type', 'password');
            $icon.removeClass('layui-icon-eye-invisible').addClass('layui-icon-eye');
        }
    });

    // ==================== DNS 服务器列表管理 ====================
    // 创建 DNS 输入项
    function createDnsItem(value = '', isFirstEmpty = false) {
        const itemDiv = $('<div class="dns-item"></div>');
        const input = $('<input type="text" class="layui-input" placeholder="例如: 8.8.8.8:53">').val(value);

        // 添加/删除按钮
        const btn = isFirstEmpty ?
            $('<button type="button" class="layui-btn layui-btn-sm add-btn"><i class="layui-icon layui-icon-add-1"></i></button>') :
            $('<button type="button" class="layui-btn layui-btn-sm remove-btn"><i class="layui-icon layui-icon-delete"></i></button>');

        itemDiv.append(input).append(btn);
        return itemDiv;
    }

    // 初始化 DNS 列表
    function initDnsList(groupId, dnsArray) {
        const listContainer = $(`#dns-${groupId}-list`);
        listContainer.empty();

        // 添加现有的 DNS 服务器
        if (dnsArray && dnsArray.length > 0) {
            dnsArray.forEach(dns => {
                if (dns && dns.trim() !== '') {
                    listContainer.append(createDnsItem(dns.trim()));
                }
            });
        }

        // 总是添加一个空的输入框用于添加新的 DNS
        listContainer.append(createDnsItem('', true));
    }

    // 更新 DNS 列表按钮状态
    function updateDnsListButtons(container) {
        const items = container.find('.dns-item');
        items.each(function() {
            const btn = $(this).find('button');
            const icon = btn.find('i');
            const input = $(this).find('input');
            const isEmpty = !input.val().trim();
            const isLast = $(this).is(':last-child');

            if (isEmpty && isLast) {
                // 最后一个空项显示添加图标
                btn.removeClass('remove-btn layui-btn-disabled').addClass('add-btn').prop('disabled', false);
                icon.removeClass('layui-icon-delete').addClass('layui-icon-add-1');
            } else if (isEmpty && !isLast) {
                // 非最后一个空项禁用按钮
                btn.removeClass('add-btn remove-btn').addClass('layui-btn-disabled').prop('disabled', true);
                icon.removeClass('layui-icon-add-1 layui-icon-delete').addClass('layui-icon-delete');
            } else {
                // 有内容的项显示删除图标
                btn.removeClass('add-btn layui-btn-disabled').addClass('remove-btn').prop('disabled', false);
                icon.removeClass('layui-icon-add-1').addClass('layui-icon-delete');
            }
        });
    }

    // 获取 DNS 列表数据
    function getDnsListData(groupId) {
        const listContainer = $(`#dns-${groupId}-list`);
        const dnsArray = [];

        listContainer.find('.dns-item input').each(function() {
            const value = $(this).val().trim();
            if (value) {
                dnsArray.push(value);
            }
        });

        return dnsArray;
    }

    // 处理 DNS 列表点击事件
    $(document).on('click', '.dns-item button', function() {
        const item = $(this).closest('.dns-item');
        const listContainer = item.closest('.dns-list');
        const btn = $(this);
        const icon = btn.find('i');
        const input = item.find('input');

        if (btn.hasClass('add-btn')) {
            // 添加新的 DNS 项
            if (input.val().trim()) {
                listContainer.append(createDnsItem('', true));
                // 将当前按钮改为删除按钮
                btn.removeClass('add-btn').addClass('remove-btn');
                icon.removeClass('layui-icon-add-1').addClass('layui-icon-delete');
                updateDnsListButtons(listContainer);
            }
        } else if (btn.hasClass('remove-btn')) {
            // 删除当前 DNS 项
            item.remove();
            updateDnsListButtons(listContainer);

            // 确保至少有一个空输入框
            if (listContainer.find('.dns-item').length === 0 ||
                listContainer.find('.dns-item:last input').val().trim()) {
                listContainer.append(createDnsItem('', true));
            }
            updateDnsListButtons(listContainer);
        }
    });

    // 处理 DNS 输入框变化
    $(document).on('input', '.dns-item input', function() {
        const item = $(this).closest('.dns-item');
        const listContainer = item.closest('.dns-list');
        const input = $(this);
        const btn = item.find('button');
        const icon = btn.find('i');

        // 如果输入框有内容且是最后一项，添加新的空输入框
        if (input.val().trim() && item.is(':last-child')) {
            listContainer.append(createDnsItem('', true));
            // 将当前按钮改为删除按钮
            btn.removeClass('add-btn').addClass('remove-btn');
            icon.removeClass('layui-icon-add-1').addClass('layui-icon-delete');
        }

        updateDnsListButtons(listContainer);
    });

    // ==================== 探测端口列表管理 ====================
    // 创建探测端口输入项
    function createPortItem(value = '', isFirstEmpty = false) {
        const itemDiv = $('<div class="dns-item"></div>');
        const input = $('<input type="number" class="layui-input" placeholder="例如: 80">').val(value);
        input.attr('min', '1');
        input.attr('max', '65535');

        // 添加/删除按钮
        const btn = isFirstEmpty ?
            $('<button type="button" class="layui-btn layui-btn-sm add-btn"><i class="layui-icon layui-icon-add-1"></i></button>') :
            $('<button type="button" class="layui-btn layui-btn-sm remove-btn"><i class="layui-icon layui-icon-delete"></i></button>');

        itemDiv.append(input).append(btn);
        return itemDiv;
    }

    // 初始化探测端口列表
    function initPortsList(portsArray) {
        const listContainer = $('#probing-ports-list');
        listContainer.empty();

        // 添加现有的端口
        if (portsArray && portsArray.length > 0) {
            portsArray.forEach(port => {
                if (port && port > 0 && port <= 65535) {
                    listContainer.append(createPortItem(port));
                }
            });
        }

        // 总是添加一个空的输入框用于添加新的端口
        listContainer.append(createPortItem('', true));
    }

    // 获取探测端口列表数据
    function getPortsListData() {
        const listContainer = $('#probing-ports-list');
        const portsArray = [];

        listContainer.find('.dns-item input').each(function() {
            const value = parseInt($(this).val());
            if (value && value > 0 && value <= 65535) {
                portsArray.push(value);
            }
        });

        return portsArray;
    }

    // 全局配置对象
    let config = null;

    // ==================== 配置加载与保存 ====================
    
    // 从后端加载配置
    function loadConfig() {
        // 从真实的后端 API 调用
        fetch('/api/config')
            .then(res => res.json())
            .then(data => {
                // API 返回的是 {success: true, data: {...}} 格式
                config = data.success ? data.data : data;
                initAllForms();
                layer.msg('配置加载成功', {icon: 1});
            })
            .catch(err => {
                layer.msg('配置加载失败: ' + err.message, {icon: 2});
                layer.open({
                    type: 1,
                    title: '连接错误',
                    content: `
                        <div style="padding: 20px; text-align: center;">
                            <div style="margin-bottom: 15px;">
                                <i class="layui-icon layui-icon-face-cry" style="font-size: 48px; color: #FF5722;"></i>
                            </div>
                            <div style="margin-bottom: 15px;">无法连接到服务器，请检查服务器是否正常运行。</div>
                            <button type="button" class="layui-btn layui-btn-primary" onclick="location.reload()">重试</button>
                        </div>
                    `,
                    area: ['400px', '250px']
                });
            });
    }

    // 保存配置到后端
    function saveConfig() {
        // 暂时注释掉真实的后端 API 调用，避免保存错误数据
        // fetch('/api/config', {
        //     method: 'POST',
        //     headers: {'Content-Type': 'application/json'},
        //     body: JSON.stringify(config)
        // })
        // .then(res => res.json())
        // .then(data => {
        //     layer.msg('配置保存成功', {icon: 1});
        // })
        // .catch(err => {
        //     layer.msg('配置保存失败: ' + err.message, {icon: 2});
        // });

        layer.msg('配置修改功能已暂时禁用，请手动编辑配置文件', {icon: 0});
        console.log('当前配置:', JSON.stringify(config, null, 2));
    }

    // ==================== 初始化所有表单 ====================
    
    function initAllForms() {
        // 安全检查
        if (!config || !config.listener) {
            layer.msg('配置格式错误', {icon: 2});
            return;
        }

        // 监听配置
        form.val("listenerForm", {
            "socks5_port": config.listener.socks5_port,
            "web_port": config.listener.web_port,
            "dns_port": config.listener.dns_port,
            "ipv6_enabled": config.listener.ipv6_enabled
        });

        // SOCKS5 配置
        form.val("socks5Form", {
            "enable_auth": config.socks5.enable_auth
        });
        if(config.socks5.enable_auth) {
            $('#authUsersCard').show();
            renderUserTable();
        }

        // 智能代理配置
        form.val("smartProxyForm", {
            "smart_proxy_enabled": config.smart_proxy.enabled,
            "timeout_ms": config.smart_proxy.timeout_ms,
            "blacklist_expiry_minutes": config.smart_proxy.blacklist_expiry_minutes
        });

        // 初始化探测端口列表
        if (config.smart_proxy && config.smart_proxy.probing_ports) {
            initPortsList(config.smart_proxy.probing_ports);
        } else {
            initPortsList([]);
        }

        // CHNRoutes 配置
        if (config.router.chnroutes) {
            form.val("chnroutesForm", {
                "chnroutes_enabled": config.router.chnroutes.enable,
                "chnroutes_path": config.router.chnroutes.path
            });
        }

        // DNS 配置
        form.val("dnsForm", {
            "dns_enabled": config.dns.enabled,
            "cache_max_size": config.dns.cache.max_size,
            "cache_default_ttl": config.dns.cache.default_ttl,
            "cache_cleanup_interval": config.dns.cache.cleanup_interval
        });

        if (config.dns && config.dns.groups) {
            // 使用新的 DNS 列表初始化函数
            initDnsList('cn', config.dns.groups.cn || []);
            initDnsList('foreign', config.dns.groups.foreign || []);
        } else {
            // 如果没有 DNS 配置，初始化空列表
            initDnsList('cn', []);
            initDnsList('foreign', []);
        }

        // NAT 配置
        if (config.nat_traversal) {
            form.val("natForm", {
                "nat_enabled": config.nat_traversal.enabled,
                "nat_mode": config.nat_traversal.mode,
                "stun_servers": (config.nat_traversal.stun_servers || []).join('\n'),
                "turn_server": config.nat_traversal.turn_server,
                "turn_username": config.nat_traversal.turn_username,
                "turn_password": config.nat_traversal.turn_password,
                "upnp_enabled": config.nat_traversal.upnp_enabled,
                "port_start": config.nat_traversal.port_mapping_range ? config.nat_traversal.port_mapping_range.start : '',
                "port_end": config.nat_traversal.port_mapping_range ? config.nat_traversal.port_mapping_range.end : '',
                "keepalive_interval": config.nat_traversal.keepalive_interval,
                "stun_timeout": config.nat_traversal.stun_timeout,
                "hole_punch_count": config.nat_traversal.hole_punch_count,
                "hole_punch_delay": config.nat_traversal.hole_punch_delay
            });
        }

        // 根据 NAT 穿透开关状态显示/隐藏配置项
        if (config.nat_traversal && config.nat_traversal.enabled) {
            $('#nat-config-items').show();
        } else {
            $('#nat-config-items').hide();
        }

        // 日志配置
        form.val("loggingForm", {
            "log_level": config.logging.level,
            "output_file": config.logging.output_file,
            "enable_time": config.logging.enable_time,
            "enable_colors": config.logging.enable_colors,
            "prefix": config.logging.prefix
        });

        // 渲染表格
        renderRulesTable();
        renderNodesTable();
        renderHijackTable();

        // 监听 NAT 穿透开关
    form.on('switch(nat_enabled)', function(data){
        const isChecked = data.elem.checked;
        if (isChecked) {
            $('#nat-config-items').show();
            // 初始显示/隐藏设置组
            updateNatSettingsVisibility();
        } else {
            $('#nat-config-items').hide();
        }
    });

    // 监听 NAT 模式选择变化
    form.on('select(nat_mode)', function(data){
        updateNatSettingsVisibility();
    });

    // 根据选择的模式更新设置组的可见性
    function updateNatSettingsVisibility() {
        const selectedMode = $('select[name="nat_mode"]').val();

        // 遍历所有设置组
        $('.nat-settings-group').each(function() {
            const $group = $(this);
            const modes = $group.data('modes').toString().split(',');

            // 如果当前模式在组的支持列表中，或者模式是auto，则显示
            if (modes.includes(selectedMode) || selectedMode === 'auto') {
                $group.show();
            } else {
                $group.hide();
            }
        });
    }

    form.render();

    // 初始化 NAT 设置可见性
    updateNatSettingsVisibility();
    }

    // ==================== 工具函数 ====================
    
    // 字节格式化
    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // ==================== 表格渲染函数 ====================
    
    // 渲染用户表格
    function renderUserTable() {
        table.render({
            elem: '#userTable',
            data: config.socks5.auth_users.map((u, i) => ({...u, id: i})),
            cols: [[
                {field: 'username', title: '用户名', width: 120},
                {field: 'user_groups', title: '用户组', width: 100, templet: function(d){
                    return d.user_groups.join(', ');
                }},
                {field: 'rate_limit', title: '上行限速', width: 110, templet: function(d){
                    return formatBytes(d.rate_limit.upload_bps) + '/s';
                }},
                {field: 'rate_limit', title: '下行限速', width: 110, templet: function(d){
                    return formatBytes(d.rate_limit.download_bps) + '/s';
                }},
                {field: 'connection_limit', title: '最大连接', width: 90, templet: function(d){
                    return d.connection_limit.max_connections;
                }},
                {field: 'connection_limit', title: '过期(分钟)', width: 100, templet: function(d){
                    return d.connection_limit.expires_after_minutes || 'N/A';
                }},
                {field: 'enabled', title: '状态', width: 90, templet: function(d){
                    return '<input type="checkbox" lay-skin="switch" lay-text="启用|禁用" lay-filter="userStatus" data-id="' + d.id + '" ' + (d.enabled ? 'checked' : '') + '>';
                }},
                {title: '操作', width: 150, templet: function(d){
                    return '<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>' +
                           '<a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">删除</a>';
                }}
            ]],
            size: 'sm',
            skin: 'line'
        });
    }

    // 渲染路由规则表格
    function renderRulesTable() {
        table.render({
            elem: '#rulesTable',
            data: config.router.rules.map((r, i) => ({...r, id: i})),
            cols: [[
                {field: 'action', title: '动作', width: 100, templet: function(d){
                    let cls = 'tag-success';
                    if(d.action === 'deny') cls = 'tag-warning';
                    if(d.action === 'block') cls = 'tag-error';
                    return '<span class="tag ' + cls + '">' + d.action + '</span>';
                }},
                {field: 'patterns', title: '匹配模式', minWidth: 200, templet: function(d){
                    return d.patterns.slice(0, 3).join(', ') + (d.patterns.length > 3 ? '...' : '');
                }},
                {field: 'description', title: '描述', minWidth: 150},
                {title: '操作', width: 150, templet: function(d){
                    return '<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>' +
                           '<a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">删除</a>';
                }}
            ]],
            size: 'sm',
            skin: 'line'
        });
    }

    // 渲染代理节点表格
    function renderNodesTable() {
        table.render({
            elem: '#nodesTable',
            data: config.router.proxy_nodes.map((n, i) => ({...n, id: i})),
            cols: [[
                {field: 'name', title: '节点名称', width: 150},
                {field: 'type', title: '类型', width: 100},
                {field: 'address', title: '地址', width: 200},
                {field: 'enabled', title: '状态', width: 90, templet: function(d){
                    return '<input type="checkbox" lay-skin="switch" lay-text="启用|禁用" lay-filter="nodeStatus" data-id="' + d.id + '" ' + (d.enabled ? 'checked' : '') + '>';
                }},
                {field: 'description', title: '描述', minWidth: 150},
                {title: '操作', width: 150, templet: function(d){
                    return '<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>' +
                           '<a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">删除</a>';
                }}
            ]],
            size: 'sm',
            skin: 'line'
        });
    }

    // 渲染 DNS 劫持表格
    function renderHijackTable() {
        table.render({
            elem: '#hijackTable',
            data: config.dns.hijack_rules.map((h, i) => ({...h, id: i})),
            cols: [[
                {field: 'pattern', title: '域名模式', width: 200},
                {field: 'target', title: '目标地址', width: 150},
                {field: 'description', title: '描述', minWidth: 200},
                {title: '操作', width: 150, templet: function(d){
                    return '<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>' +
                           '<a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">删除</a>';
                }}
            ]],
            size: 'sm',
            skin: 'line'
        });
    }

    // ==================== 事件监听 ====================
    
    // 认证开关
    form.on('switch(authSwitch)', function(data){
        config.socks5.enable_auth = data.elem.checked;
        if(data.elem.checked) {
            $('#authUsersCard').slideDown(300, function(){ 
                renderUserTable();
                form.render();
            });
        } else {
            $('#authUsersCard').slideUp(300);
        }
    });

    // 用户状态切换
    form.on('switch(userStatus)', function(data){
        const id = parseInt($(data.elem).data('id'));
        config.socks5.auth_users[id].enabled = data.elem.checked;
        layer.msg(config.socks5.auth_users[id].username + ' ' + (data.elem.checked ? '已启用' : '已禁用'));
    });

    // 节点状态切换
    form.on('switch(nodeStatus)', function(data){
        const id = parseInt($(data.elem).data('id'));
        config.router.proxy_nodes[id].enabled = data.elem.checked;
        layer.msg(config.router.proxy_nodes[id].name + ' ' + (data.elem.checked ? '已启用' : '已禁用'));
    });

    // 用户表格操作
    table.on('tool(userTable)', function(obj){
        const data = obj.data;
        if(obj.event === 'del'){
            layer.confirm('确认删除用户 ' + data.username + '?', function(index){
                config.socks5.auth_users.splice(data.id, 1);
                renderUserTable();
                form.render();
                layer.close(index);
                layer.msg('删除成功');
            });
        } else if(obj.event === 'edit'){
            editUser(data);
        }
    });

    // 路由规则表格操作
    table.on('tool(rulesTable)', function(obj){
        if(obj.event === 'del'){
            layer.confirm('确认删除此规则?', function(index){
                config.router.rules.splice(obj.data.id, 1);
                renderRulesTable();
                layer.close(index);
                layer.msg('删除成功');
            });
        } else if(obj.event === 'edit'){
            layer.msg('编辑规则: ' + obj.data.description);
        }
    });

    // 代理节点表格操作
    table.on('tool(nodesTable)', function(obj){
        if(obj.event === 'del'){
            layer.confirm('确认删除节点 ' + obj.data.name + '?', function(index){
                config.router.proxy_nodes.splice(obj.data.id, 1);
                renderNodesTable();
                form.render();
                layer.close(index);
                layer.msg('删除成功');
            });
        } else if(obj.event === 'edit'){
            layer.msg('编辑节点: ' + obj.data.name);
        }
    });

    // DNS 劫持表格操作
    table.on('tool(hijackTable)', function(obj){
        if(obj.event === 'del'){
            layer.confirm('确认删除此劫持规则?', function(index){
                config.dns.hijack_rules.splice(obj.data.id, 1);
                renderHijackTable();
                layer.close(index);
                layer.msg('删除成功');
            });
        } else if(obj.event === 'edit'){
            layer.msg('编辑劫持规则: ' + obj.data.pattern);
        }
    });

    // ==================== 用户编辑对话框 ====================
    
    function editUser(data) {
        const connLimit = data.connection_limit || {};
        const rateLimit = data.rate_limit || {};
        const timeRestriction = connLimit.time_restriction || {};

        // 收集所有现有的用户组
        const allUserGroups = new Set();
        config.socks5.auth_users.forEach(user => {
            if (user.user_groups) {
                user.user_groups.forEach(group => allUserGroups.add(group));
            }
        });
        const userGroupsArray = Array.from(allUserGroups).sort();

        // 生成用户组选项HTML
        let userGroupsOptions = userGroupsArray.map(group =>
            `<option value="${group}" ${(data.user_groups || [])[0] === group ? 'selected' : ''}>${group}</option>`
        ).join('');

        layer.open({
            type: 1,
            title: '编辑用户 - ' + data.username,
            area: ['550px', '650px'],
            content: `
                <div style="padding: 20px;">
                    <form class="layui-form" lay-filter="editUserForm">
                        <div class="layui-form-item">
                            <label class="layui-form-label">用户名</label>
                            <div class="layui-input-block">
                                <input type="text" name="username" value="${data.username}" class="layui-input" readonly>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">密码</label>
                            <div class="layui-input-block">
                                <div class="password-wrapper">
                                    <input type="password" name="password" value="${data.password}" class="layui-input" placeholder="留空则不修改">
                                    <i class="layui-icon layui-icon-eye password-toggle"></i>
                                </div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">用户组</label>
                            <div class="layui-input-block">
                                <select name="user_groups" lay-verify="required">
                                    <option value="">请选择用户组</option>
                                    ${userGroupsOptions}
                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">上行限速 (bps)</label>
                            <div class="layui-input-block">
                                <input type="number" name="upload_bps" value="${rateLimit.upload_bps || 0}" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">下行限速 (bps)</label>
                            <div class="layui-input-block">
                                <input type="number" name="download_bps" value="${rateLimit.download_bps || 0}" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">最大连接数</label>
                            <div class="layui-input-block">
                                <input type="number" name="max_connections" value="${connLimit.max_connections || 0}" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">过期(分钟)</label>
                            <div class="layui-input-block">
                                <input type="number" name="expires_after_minutes" value="${connLimit.expires_after_minutes || 0}" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">IP白名单</label>
                            <div class="layui-input-block">
                                <textarea name="allow_from_ips" class="layui-textarea" placeholder="每行一个IP或CIDR">${(connLimit.allow_from_ips || []).join('\n')}</textarea>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">IP黑名单</label>
                            <div class="layui-input-block">
                                <textarea name="block_from_ips" class="layui-textarea" placeholder="每行一个IP或CIDR">${(connLimit.block_from_ips || []).join('\n')}</textarea>
                            </div>
                        </div>

                        <div class="config-group">
                            <div class="sub-title">时间限制</div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">允许时间</label>
                                <div class="layui-input-block">
                                    <div class="layui-btn-group" style="margin-bottom: 10px;">
                                        <button type="button" class="layui-btn layui-btn-primary layui-btn-sm" onclick="addTimeSlot(this)">
                                            <i class="layui-icon layui-icon-add-1"></i> 添加时间段
                                        </button>
                                        <button type="button" class="layui-btn layui-btn-primary layui-btn-sm" onclick="addSingleHour(this)">
                                            <i class="layui-icon layui-icon-time"></i> 添加小时
                                        </button>
                                    </div>
                                    <div id="allowed-hours-list">
                                        <!-- 动态生成的时间项 -->
                                    </div>
                                    <div style="margin-top: 10px; color: #666; font-size: 12px;">
                                        支持格式：
                                        <br>• 时间段：09:00-18:00（表示9点到18点）
                                        <br>• 单个小时：9、14、20（表示9点、14点、20点）
                                    </div>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">允许星期</label>
                                <div class="layui-input-block">
                                    <input type="checkbox" name="allowed_days_monday" title="周一" ${(timeRestriction.allowed_days || []).includes('monday') ? 'checked' : ''}>
                                    <input type="checkbox" name="allowed_days_tuesday" title="周二" ${(timeRestriction.allowed_days || []).includes('tuesday') ? 'checked' : ''}>
                                    <input type="checkbox" name="allowed_days_wednesday" title="周三" ${(timeRestriction.allowed_days || []).includes('wednesday') ? 'checked' : ''}>
                                    <input type="checkbox" name="allowed_days_thursday" title="周四" ${(timeRestriction.allowed_days || []).includes('thursday') ? 'checked' : ''}>
                                    <input type="checkbox" name="allowed_days_friday" title="周五" ${(timeRestriction.allowed_days || []).includes('friday') ? 'checked' : ''}>
                                    <input type="checkbox" name="allowed_days_saturday" title="周六" ${(timeRestriction.allowed_days || []).includes('saturday') ? 'checked' : ''}>
                                    <input type="checkbox" name="allowed_days_sunday" title="周日" ${(timeRestriction.allowed_days || []).includes('sunday') ? 'checked' : ''}>
                                    <div style="margin-top: 10px;">
                                        <button type="button" class="layui-btn layui-btn-primary layui-btn-xs" onclick="selectAllDays()">全选</button>
                                        <button type="button" class="layui-btn layui-btn-primary layui-btn-xs" onclick="selectWeekdays()">工作日</button>
                                        <button type="button" class="layui-btn layui-btn-primary layui-btn-xs" onclick="selectWeekends()">周末</button>
                                        <button type="button" class="layui-btn layui-btn-primary layui-btn-xs" onclick="clearAllDays()">清空</button>
                                    </div>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">时区</label>
                                <div class="layui-input-block">
                                    <select name="timezone" lay-verify="">
                                        <option value="UTC" ${timeRestriction.timezone === 'UTC' ? 'selected' : ''}>UTC</option>
                                        <option value="Asia/Shanghai" ${(!timeRestriction.timezone || timeRestriction.timezone === 'Asia/Shanghai') ? 'selected' : ''}>Asia/Shanghai (中国)</option>
                                        <option value="Asia/Tokyo" ${timeRestriction.timezone === 'Asia/Tokyo' ? 'selected' : ''}>Asia/Tokyo (日本)</option>
                                        <option value="Asia/Seoul" ${timeRestriction.timezone === 'Asia/Seoul' ? 'selected' : ''}>Asia/Seoul (韩国)</option>
                                        <option value="America/New_York" ${timeRestriction.timezone === 'America/New_York' ? 'selected' : ''}>America/New_York (纽约)</option>
                                        <option value="Europe/London" ${timeRestriction.timezone === 'Europe/London' ? 'selected' : ''}>Europe/London (伦敦)</option>
                                        <option value="Europe/Paris" ${timeRestriction.timezone === 'Europe/Paris' ? 'selected' : ''}>Europe/Paris (巴黎)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">生效日期</label>
                                <div class="layui-input-block">
                                    <input type="text" id="effective-dates" name="effective_dates" class="layui-input" placeholder="选择生效日期" readonly>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">过期日期</label>
                                <div class="layui-input-block">
                                    <input type="text" id="expired-dates" name="expired_dates" class="layui-input" placeholder="选择过期日期" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="layui-form-item">
                            <div class="layui-input-block">
                                <button type="button" class="layui-btn" id="saveEditUser">保存</button>
                                <button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll()">取消</button>
                            </div>
                        </div>
                    </form>
                </div>
            `,
            success: function(layero, index) {
                // 初始化时间配置
                initAllowedHours(timeRestriction.allowed_hours || []);

                // 初始化日期选择器
                laydate.render({
                    elem: '#effective-dates',
                    type: 'date',
                    format: 'yyyy-MM-dd',
                    trigger: 'click'
                });

                laydate.render({
                    elem: '#expired-dates',
                    type: 'date',
                    format: 'yyyy-MM-dd',
                    trigger: 'click'
                });

                // 最后渲染表单，确保所有元素都已准备好
                form.render();

                // 特别渲染select元素
                form.render('select');
                form.render('select', 'editUserForm');

                $(layero).find('#saveEditUser').on('click', function(){
                    const formData = form.val('editUserForm');
                    const user = config.socks5.auth_users[data.id];
                    if(formData.password) user.password = formData.password;

                    // 处理用户组 - layui单选下拉框返回字符串
                    if(formData.user_groups) {
                        user.user_groups = [formData.user_groups];
                    }

                    user.rate_limit = user.rate_limit || {};
                    user.rate_limit.upload_bps = parseInt(formData.upload_bps) || 0;
                    user.rate_limit.download_bps = parseInt(formData.download_bps) || 0;

                    user.connection_limit = user.connection_limit || {};
                    user.connection_limit.max_connections = parseInt(formData.max_connections) || 0;
                    user.connection_limit.expires_after_minutes = parseInt(formData.expires_after_minutes) || 0;
                    user.connection_limit.allow_from_ips = formData.allow_from_ips.split('\n').filter(ip => ip.trim() !== '');
                    user.connection_limit.block_from_ips = formData.block_from_ips.split('\n').filter(ip => ip.trim() !== '');

                    // 处理时间限制
                    user.connection_limit.time_restriction = user.connection_limit.time_restriction || {};

                    // 收集所有允许时间
                    const hours = collectAllowedHours();
                    if (hours.length > 0) {
                        user.connection_limit.time_restriction.allowed_hours = hours;
                    } else {
                        delete user.connection_limit.time_restriction.allowed_hours;
                    }

                    // 处理允许星期
                    const days = collectAllowedDays();
                    if (days.length > 0) {
                        user.connection_limit.time_restriction.allowed_days = days;
                    } else {
                        delete user.connection_limit.time_restriction.allowed_days;
                    }

                    // 处理时区
                    if(formData.timezone) {
                        user.connection_limit.time_restriction.timezone = formData.timezone;
                    }

                    // 处理生效日期
                    if(formData.effective_dates) {
                        user.connection_limit.time_restriction.effective_dates = [formData.effective_dates.trim()];
                    }

                    // 处理过期日期
                    if(formData.expired_dates) {
                        user.connection_limit.time_restriction.expired_dates = [formData.expired_dates.trim()];
                    }

                    renderUserTable();
                    form.render();
                    layer.close(index);
                    layer.msg('保存成功');
                });
            }
        });
    }

    // ==================== 按钮事件 ====================
    
    // 新增用户
    $('#addUserBtn').on('click', function(){
        // 收集所有现有的用户组作为推荐
        const allUserGroups = new Set();
        config.socks5.auth_users.forEach(user => {
            if (user.user_groups) {
                user.user_groups.forEach(group => allUserGroups.add(group));
            }
        });
        const userGroupsArray = Array.from(allUserGroups).sort();

        layer.open({
            type: 1,
            title: '新增用户',
            area: ['550px', '680px'],
            content: `
                <div style="padding: 20px;">
                    <form class="layui-form" lay-filter="addUserForm">
                        <div class="layui-form-item">
                            <label class="layui-form-label">用户名</label>
                            <div class="layui-input-block">
                                <input type="text" name="username" class="layui-input" required lay-verify="required">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">密码</label>
                            <div class="layui-input-block">
                                <div class="password-wrapper">
                                    <input type="password" name="password" class="layui-input" required lay-verify="required">
                                    <i class="layui-icon layui-icon-eye password-toggle"></i>
                                </div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">用户组</label>
                            <div class="layui-input-block">
                                <select name="user_group" lay-search="{caseSensitive:false, fuzzy: true}" lay-creatable="" lay-verify="required">
                                    <option value="">选择或输入用户组</option>
                                    ${userGroupsArray.map(group => `<option value="${group}">${group}</option>`).join('')}
                                    <option value="">--- 推荐 ---</option>
                                    <option value="admin">admin</option>
                                    <option value="user">user</option>
                                    <option value="guest">guest</option>
                                    <option value="vip">vip</option>
                                    <option value="moderator">moderator</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">上行限速 (bps)</label>
                            <div class="layui-input-block">
                                <input type="number" name="upload_bps" value="1048576" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">下行限速 (bps)</label>
                            <div class="layui-input-block">
                                <input type="number" name="download_bps" value="1048576" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">最大连接数</label>
                            <div class="layui-input-block">
                                <input type="number" name="max_connections" value="5" class="layui-input">
                            </div>
                        </div>
                         <div class="layui-form-item">
                            <label class="layui-form-label">过期(分钟)</label>
                            <div class="layui-input-block">
                                <input type="number" name="expires_after_minutes" value="1440" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">IP白名单</label>
                            <div class="layui-input-block">
                                <textarea name="allow_from_ips" class="layui-textarea" placeholder="每行一个IP或CIDR"></textarea>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">IP黑名单</label>
                            <div class="layui-input-block">
                                <textarea name="block_from_ips" class="layui-textarea" placeholder="每行一个IP或CIDR"></textarea>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <div class="layui-input-block">
                                <button type="button" class="layui-btn" id="saveNewUser">添加</button>
                                <button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll()">取消</button>
                            </div>
                        </div>
                    </form>
                </div>
            `,
            success: function(layero, index) {
                form.render();
                $(layero).find('#saveNewUser').on('click', function(){
                    const formData = form.val('addUserForm');
                    if(!formData.username || !formData.password) {
                        layer.msg('请填写用户名和密码', {icon: 2});
                        return;
                    }
                    const newUser = {
                        username: formData.username,
                        password: formData.password,
                        enabled: true,
                        user_groups: [formData.user_group],
                        rate_limit: {
                            upload_bps: parseInt(formData.upload_bps) || 0,
                            download_bps: parseInt(formData.download_bps) || 0
                        },
                        connection_limit: {
                            max_connections: parseInt(formData.max_connections) || 0,
                            expires_after_minutes: parseInt(formData.expires_after_minutes) || 0,
                            allow_from_ips: formData.allow_from_ips.split('\n').filter(ip => ip.trim() !== ''),
                            block_from_ips: formData.block_from_ips.split('\n').filter(ip => ip.trim() !== '')
                        }
                    };
                    config.socks5.auth_users.push(newUser);
                    renderUserTable();
                    form.render();
                    layer.close(index);
                    layer.msg('添加成功');
                });
            }
        });
    });

    // 保存监听配置
    $('#saveListener').on('click', function(){
        const formData = form.val('listenerForm');
        config.listener.socks5_port = parseInt(formData.socks5_port);
        config.listener.web_port = parseInt(formData.web_port);
        config.listener.dns_port = parseInt(formData.dns_port);
        config.listener.ipv6_enabled = formData.ipv6_enabled === 'on';
        saveConfig();
    });

    // 保存路由配置
    $('#saveRouterConfig').on('click', function(){
        const smartProxyData = form.val('smartProxyForm');
        config.smart_proxy.enabled = smartProxyData.smart_proxy_enabled === 'on';
        config.smart_proxy.timeout_ms = parseInt(smartProxyData.timeout_ms);
        config.smart_proxy.blacklist_expiry_minutes = parseInt(smartProxyData.blacklist_expiry_minutes);
        // 使用新的探测端口列表获取函数
        config.smart_proxy.probing_ports = getPortsListData();

        if (config.router.chnroutes) {
            const chnroutesData = form.val('chnroutesForm');
            config.router.chnroutes.enable = chnroutesData.chnroutes_enabled === 'on';
            config.router.chnroutes.path = chnroutesData.chnroutes_path;
        }
        saveConfig();
    });

    // 保存DNS配置
    $('#saveDnsConfig').on('click', function(){
        const dnsData = form.val('dnsForm');
        config.dns.enabled = dnsData.dns_enabled === 'on';
        config.dns.cache.max_size = parseInt(dnsData.cache_max_size);
        config.dns.cache.default_ttl = parseInt(dnsData.cache_default_ttl);
        config.dns.cache.cleanup_interval = parseInt(dnsData.cache_cleanup_interval);

        if (config.dns.groups) {
            // 使用新的 DNS 列表获取函数
            config.dns.groups.cn = getDnsListData('cn');
            config.dns.groups.foreign = getDnsListData('foreign');
        }
        saveConfig();
    });

    // 保存NAT配置
    $('#saveNatConfig').on('click', function(){
        const natData = form.val('natForm');
        config.nat_traversal.enabled = natData.nat_enabled === 'on';
        config.nat_traversal.mode = natData.nat_mode;
        config.nat_traversal.stun_servers = natData.stun_servers.split('\n').filter(s => s.trim() !== '');
        config.nat_traversal.turn_server = natData.turn_server;
        config.nat_traversal.turn_username = natData.turn_username;
        config.nat_traversal.turn_password = natData.turn_password;
        config.nat_traversal.upnp_enabled = natData.upnp_enabled === 'on';
        config.nat_traversal.port_mapping_range.start = parseInt(natData.port_start);
        config.nat_traversal.port_mapping_range.end = parseInt(natData.port_end);
        config.nat_traversal.keepalive_interval = parseInt(natData.keepalive_interval);
        config.nat_traversal.stun_timeout = parseInt(natData.stun_timeout);
        config.nat_traversal.hole_punch_count = parseInt(natData.hole_punch_count);
        config.nat_traversal.hole_punch_delay = parseInt(natData.hole_punch_delay);
        saveConfig();
    });

    // 保存日志配置
    $('#saveLogging').on('click', function(){
        const formData = form.val('loggingForm');
        config.logging.level = formData.log_level;
        config.logging.output_file = formData.output_file;
        config.logging.enable_time = formData.enable_time === 'on';
        config.logging.enable_colors = formData.enable_colors === 'on';
        config.logging.prefix = formData.prefix;
        saveConfig();
    });

    // 重新加载配置
    $('#reloadConfig').on('click', function(){
        layer.confirm('确认重新加载配置？未保存的更改将丢失', function(index){
            loadConfig();
            layer.close(index);
            layer.msg('配置已重新加载');
        });
    });

    // ==================== 导航和界面 ====================
    
    // 导航切换
    $('.nav-item').on('click', function(){
        const page = $(this).data('page');
        const label = $(this).data('label');
        
        $('.nav-item').removeClass('active');
        $(this).addClass('active');
        $('.page-section').removeClass('active');
        $('#page-' + page).addClass('active');
        $('#title-display').text(label);
        
        if($(window).width() <= 768) {
            $('#sidebar').removeClass('mobile-open');
            $('#mask').removeClass('show');
        }
    });

    // 侧边栏切换
    $('#toggleBtn, #mask').on('click', function(){
        if($(window).width() > 768) {
            $('body').toggleClass('sidebar-mini');
        } else {
            $('#sidebar').toggleClass('mobile-open');
            $('#mask').toggleClass('show');
        }
    });

    // 端口验证
    $(document).on('input focus', '.port-input', function(){
        const val = parseInt($(this).val());
        const $tip = $(this).parent().next('.port-tip');
        
        $(this).removeClass('port-warning port-error');
        $tip.removeClass('show text-warning text-error').html('');
        
        if (isNaN(val) || val < 1 || val > 65535) {
            $(this).addClass('port-error');
            $tip.addClass('show text-error').html('<i class="layui-icon layui-icon-close"></i> 端口范围: 1-65535');
        } else if (val < 1024) {
            $(this).addClass('port-warning');
            $tip.addClass('show text-warning').html('<i class="layui-icon layui-icon-tips"></i> 建议使用 >1024');
        }
    });

    // ==================== 流量图表 ====================
    
    const ctx = document.getElementById('trafficChart').getContext('2d');
    const trafficChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array(20).fill(''),
            datasets: [{
                label: '下行速度',
                data: Array(20).fill(0),
                borderColor: '#1677ff',
                backgroundColor: 'rgba(22,119,255,0.05)',
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            },
            scales: {
                x: { display: false },
                y: { 
                    beginAtZero: true,
                    ticks: { color: '#999' },
                    grid: { color: 'rgba(0,0,0,0.05)' }
                }
            },
            animation: { duration: 0 }
        }
    });

    // 更新流量数据
    setInterval(function(){
        const down = Math.floor(Math.random() * 500) + 50;
        const up = Math.floor(down / 7);
        
        trafficChart.data.datasets[0].data.shift();
        trafficChart.data.datasets[0].data.push(down);
        trafficChart.update('none');
        
        $('#down-speed').text(down);
        $('#up-speed').text(up);
    }, 1000);

    // 初始化加载配置
    loadConfig();
});
</script>
</body>
</html>