<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»‘åå•ç®¡ç†ç³»ç»Ÿ - SmartProxy</title>
    <link rel="stylesheet" href="layui-v2.13.1/layui/css/layui.css">
    <style>
        body {
            padding: 20px;
            background-color: #f5f7fa;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .chart-container {
            height: 300px;
            margin: 20px 0;
        }
        .tree-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #e6e6e6;
            padding: 10px;
            border-radius: 4px;
        }
        .failure-badge {
            background: #ff5722;
            color: white;
            padding: 2px 8px;
            border-radius: 2px;
            font-size: 12px;
            margin-left: 5px;
        }
        .domain-type {
            color: #2196F3;
            font-weight: bold;
        }
        .ip-type {
            color: #4CAF50;
            font-weight: bold;
        }
        .expired-badge {
            background: #9e9e9e;
            color: white;
            padding: 2px 8px;
            border-radius: 2px;
            font-size: 12px;
            margin-left: 5px;
        }
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 style="margin: 0 0 10px 0;">ğŸš« é»‘åå•ç®¡ç†ç³»ç»Ÿ</h1>
        <p style="margin: 0; color: #718096;">æŸ¥çœ‹å’Œç®¡ç†è¢«å±è”½çš„åŸŸåå’ŒIPåœ°å€</p>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md3 layui-col-xs12">
            <div class="card">
                <div class="layui-row layui-col-space10">
                    <div class="layui-col-xs7">
                        <h3 style="margin: 0; color: #2d3748;">æ€»å±è”½é¡¹</h3>
                        <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold; color: #667eea;" id="total-items">-</p>
                    </div>
                    <div class="layui-col-xs5" style="text-align: right;">
                        <i class="layui-icon layui-icon-file" style="font-size: 48px; color: #667eea;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-col-md3 layui-col-xs12">
            <div class="card">
                <div class="layui-row layui-col-space10">
                    <div class="layui-col-xs7">
                        <h3 style="margin: 0; color: #2d3748;">åŸŸåå±è”½</h3>
                        <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold; color: #f6ad55;" id="total-domains">-</p>
                    </div>
                    <div class="layui-col-xs5" style="text-align: right;">
                        <i class="layui-icon layui-icon-url" style="font-size: 48px; color: #f6ad55;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-col-md3 layui-col-xs12">
            <div class="card">
                <div class="layui-row layui-col-space10">
                    <div class="layui-col-xs7">
                        <h3 style="margin: 0; color: #2d3748;">IPå±è”½</h3>
                        <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold; color: #48bb78;" id="total-ips">-</p>
                    </div>
                    <div class="layui-col-xs5" style="text-align: right;">
                        <i class="layui-icon layui-icon-location" style="font-size: 48px; color: #48bb78;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-col-md2 layui-col-xs6">
            <div class="card">
                <div class="layui-row layui-col-space10">
                    <div class="layui-col-xs7">
                        <h3 style="margin: 0; color: #2d3748;">å·²è¿‡æœŸé¡¹</h3>
                        <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold; color: #fc8181;" id="total-expired">-</p>
                    </div>
                    <div class="layui-col-xs5" style="text-align: right;">
                        <i class="layui-icon layui-icon-time" style="font-size: 48px; color: #fc8181;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-col-md2 layui-col-xs6">
            <div class="card">
                <div class="layui-row layui-col-space10">
                    <div class="layui-col-xs7">
                        <h3 style="margin: 0; color: #2d3748;">æ€»è®¿é—®æ¬¡æ•°</h3>
                        <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold; color: #4299e1;" id="total-attempts">-</p>
                    </div>
                    <div class="layui-col-xs5" style="text-align: right;">
                        <i class="layui-icon layui-icon-chart-screen" style="font-size: 48px; color: #4299e1;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-col-md2 layui-col-xs6">
            <div class="card">
                <div class="layui-row layui-col-space10">
                    <div class="layui-col-xs7">
                        <h3 style="margin: 0; color: #2d3748;">å±è”½ç‡</h3>
                        <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold; color: #9f7aea;" id="block-rate">-</p>
                    </div>
                    <div class="layui-col-xs5" style="text-align: right;">
                        <i class="layui-icon layui-icon-rate" style="font-size: 48px; color: #9f7aea;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md3 layui-col-xs12">
            <div class="card">
                <h3 style="margin-top: 0;">å±è”½ç‡</h3>
                <div class="chart-container">
                    <canvas id="blockRateChart"></canvas>
                </div>
            </div>
        </div>
        <div class="layui-col-md3 layui-col-xs12">
            <div class="card">
                <h3 style="margin-top: 0;">åè®®å æ¯”</h3>
                <div class="chart-container">
                    <canvas id="protocolChart"></canvas>
                </div>
            </div>
        </div>
        <div class="layui-col-md3 layui-col-xs12">
            <div class="card">
                <h3 style="margin-top: 0;">å¤±è´¥åŸå› åˆ†å¸ƒ</h3>
                <div class="chart-container">
                    <canvas id="failureReasonChart"></canvas>
                </div>
            </div>
        </div>
        <div class="layui-col-md3 layui-col-xs12">
            <div class="card">
                <h3 style="margin-top: 0;">å±è”½è¶‹åŠ¿ï¼ˆæœ€è¿‘24å°æ—¶ï¼‰</h3>
                <div class="chart-container">
                    <canvas id="blockTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- æ ‘å½¢ç»“æ„ -->
    <div class="card">
        <h3 style="margin-top: 0;">é»‘åå•æ ‘å½¢ç»“æ„</h3>
        <div class="tree-container" id="blacklistTree">
            <div id="tree"></div>
        </div>
    </div>

    <!-- è¯¦æƒ…è¡¨æ ¼ -->
    <div class="card">
        <div class="toolbar">
            <h3 style="margin: 0;">é»‘åå•è¯¦æƒ…</h3>
            <div>
                <button type="button" class="layui-btn layui-btn-sm" id="refreshTable">åˆ·æ–°</button>
                <button type="button" class="layui-btn layui-btn-sm layui-btn-danger" id="clearExpired">æ¸…ç†è¿‡æœŸé¡¹</button>
            </div>
        </div>
        <table id="blacklistTable" lay-filter="blacklistTable"></table>
    </div>

    <script src="layui-v2.13.1/layui/layui.js"></script>
    <script src="chart.umd.min.js"></script>
    <script>
        layui.use(['tree', 'table', 'layer'], function(){
            var tree = layui.tree;
            var table = layui.table;
            var layer = layui.layer;

            // å…¨å±€å˜é‡
            var failureReasonChart = null;
            var blockTrendChart = null;
            var blacklistData = [];

            // åˆå§‹åŒ–
            init();

            function init() {
                loadStatistics();
                loadBlacklistList();
                initCharts();
                initTree();
                initTable();

                // è‡ªåŠ¨åˆ·æ–°
                setInterval(loadStatistics, 10000);
            }

            // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
            function loadStatistics() {
                fetch('/api/blacklist')
                    .then(res => res.json())
                    .then(data => {
                        if(data.success) {
                            document.getElementById('total-items').textContent = data.data.total_blocked_items || 0;
                            document.getElementById('total-domains').textContent = data.data.total_blocked_domains || 0;
                            document.getElementById('total-ips').textContent = data.data.total_blocked_ips || 0;
                            document.getElementById('total-attempts').textContent = data.data.total_attempts || 0;
                            document.getElementById('block-rate').textContent = (data.data.block_rate_percent || 0).toFixed(2) + '%';

                            // æ›´æ–°å›¾è¡¨æ•°æ®
                            updateChartsWithData(data.data);
                        }
                    });
            }

            // åŠ è½½é»‘åå•åˆ—è¡¨
            function loadBlacklistList() {
                fetch('/api/blacklist/list?limit=1000')
                    .then(res => res.json())
                    .then(data => {
                        if(data.success) {
                            blacklistData = data.data.items;

                            // è®¡ç®—è¿‡æœŸæ•°é‡
                            var expiredCount = data.data.items.filter(item => item.is_expired).length;
                            document.getElementById('total-expired').textContent = expiredCount;

                            // æ›´æ–°å›¾è¡¨
                            updateCharts(data.data.items);

                            // æ›´æ–°æ ‘
                            updateTree(data.data.items);

                            // è®¡ç®—åè®®åˆ†å¸ƒ
                            calculateProtocolDistribution(data.data.items);

                            // æ›´æ–°è¡¨æ ¼
                            table.reload('blacklistTable', {
                                data: data.data.items
                            });
                        }
                    });
            }

            // åˆå§‹åŒ–å›¾è¡¨
            function initCharts() {
                // å±è”½ç‡ç¯å½¢å›¾
                var ctx0 = document.getElementById('blockRateChart').getContext('2d');
                var blockRateChart = new Chart(ctx0, {
                    type: 'doughnut',
                    data: {
                        labels: ['å±è”½ç‡', 'æœªå±è”½ç‡'],
                        datasets: [{
                            data: [0, 100],
                            backgroundColor: ['#f6ad55', '#e2e8f0']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed + '%';
                                    }
                                }
                            }
                        }
                    }
                });

                // åè®®å æ¯”å›¾
                var ctx1 = document.getElementById('protocolChart').getContext('2d');
                var protocolChart = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: ['HTTP', 'HTTPS', 'å…¶ä»–'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: ['#f687b3', '#68d391', '#4299e1']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                // å¤±è´¥åŸå› åˆ†å¸ƒå›¾
                var ctx2 = document.getElementById('failureReasonChart').getContext('2d');
                failureReasonChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#4BC0C0',
                                '#9966FF'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                // å±è”½è¶‹åŠ¿å›¾
                var ctx3 = document.getElementById('blockTrendChart').getContext('2d');
                blockTrendChart = new Chart(ctx3, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'æ–°å¢å±è”½é¡¹',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // æ›´æ–°å›¾è¡¨
            function updateCharts(items) {
                // ç»Ÿè®¡å¤±è´¥åŸå› 
                var failureReasons = {};
                items.forEach(item => {
                    if(item.failure_reasons_str) {
                        for(var reason in item.failure_reasons_str) {
                            failureReasons[reason] = (failureReasons[reason] || 0) + item.failure_reasons_str[reason];
                        }
                    }
                });

                // æ›´æ–°å¤±è´¥åŸå› å›¾
                failureReasonChart.data.labels = Object.keys(failureReasons);
                failureReasonChart.data.datasets[0].data = Object.values(failureReasons);
                failureReasonChart.update();

                // æ¨¡æ‹Ÿè¶‹åŠ¿æ•°æ®ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
                var hours = [];
                var counts = [];
                for(var i = 23; i >= 0; i--) {
                    hours.push(i + 'å°æ—¶å‰');
                    counts.push(Math.floor(Math.random() * 10) + 1);
                }

                blockTrendChart.data.labels = hours;
                blockTrendChart.data.datasets[0].data = counts;
                blockTrendChart.update();
            }

            // ä½¿ç”¨APIæ•°æ®æ›´æ–°å›¾è¡¨
            function updateChartsWithData(data) {
                // æ›´æ–°å±è”½ç‡å›¾
                var blockRate = data.block_rate_percent || 0;
                var charts = Chart.getChart('blockRateChart');
                if(charts) {
                    charts.data.datasets[0].data = [blockRate, 100 - blockRate];
                    charts.update();
                }

                // åè®®åˆ†å¸ƒåœ¨å‰ç«¯è®¡ç®—
                calculateProtocolDistribution(blacklistData);
            }

            // è®¡ç®—åè®®åˆ†å¸ƒ
            function calculateProtocolDistribution(items) {
                var protocolStats = {
                    http: 0,
                    https: 0,
                    unknown: 0
                };

                items.forEach(function(item) {
                    if(item.ports && item.ports.length > 0) {
                        item.ports.forEach(function(port) {
                            if(port.port === 80) {
                                protocolStats.http++;
                            } else if(port.port === 443) {
                                protocolStats.https++;
                            } else {
                                protocolStats.unknown++;
                            }
                        });
                    }
                });

                var charts = Chart.getChart('protocolChart');
                if(charts) {
                    charts.data.datasets[0].data = [protocolStats.http, protocolStats.https, protocolStats.unknown];
                    charts.update();
                }
            }

            // åˆå§‹åŒ–æ ‘
            function initTree() {
                // æ ‘çš„æ•°æ®å°†åœ¨ updateTree ä¸­æ›´æ–°
            }

            // æ›´æ–°æ ‘
            function updateTree(items) {
                var treeData = [
                    {
                        title: 'é»‘åå•æ ¹èŠ‚ç‚¹',
                        id: 0,
                        children: []
                    }
                ];

                // æŒ‰ç±»å‹åˆ†ç»„
                var domains = [];
                var ips = [];

                items.forEach(function(item) {
                    var node = {
                        title: item.key + ' <span class="failure-badge">' + item.top_failure_reason + '</span>' +
                              (item.is_expired ? '<span class="expired-badge">å·²è¿‡æœŸ</span>' : ''),
                        id: item.key,
                        type: item.type.toLowerCase(),
                        children: []
                    };

                    // æ·»åŠ ç«¯å£ä¿¡æ¯
                    if(item.ports && item.ports.length > 0) {
                        item.ports.forEach(function(port) {
                            node.children.push({
                                title: 'ç«¯å£ ' + port.port + ' (å°è¯•' + port.attempt_count + 'æ¬¡)',
                                id: item.key + ':' + port.port
                            });
                        });
                    }

                    if(item.type === 'Domain') {
                        domains.push(node);
                    } else {
                        ips.push(node);
                    }
                });

                treeData[0].children = [
                    {
                        title: 'åŸŸå (' + domains.length + ')',
                        id: 'domains',
                        spread: true,
                        children: domains
                    },
                    {
                        title: 'IPåœ°å€ (' + ips.length + ')',
                        id: 'ips',
                        children: ips
                    }
                ];

                // æ¸²æŸ“æ ‘
                tree.render({
                    elem: '#tree',
                    data: treeData,
                    onlyIconControl: true,
                    click: function(node){
                        if(node.id && node.id !== 0 && node.id !== 'domains' && node.id !== 'ips') {
                            // æŸ¥çœ‹è¯¦æƒ…
                            showItemDetail(node.id);
                        }
                    }
                });
            }

            // åˆå§‹åŒ–è¡¨æ ¼
            function initTable() {
                table.render({
                    elem: '#blacklistTable',
                    cols: [[
                        {field: 'key', title: 'åŸŸå/IP', width: 200, templet: function(d){
                            var typeClass = d.type === 'Domain' ? 'domain-type' : 'ip-type';
                            return '<span class="' + typeClass + '">' + d.key + '</span>';
                        }},
                        {field: 'type', title: 'ç±»å‹', width: 80, templet: function(d){
                            return d.type === 'Domain' ? 'åŸŸå' : 'IP';
                        }},
                        {field: 'total_attempts', title: 'å°è¯•æ¬¡æ•°', width: 100},
                        {field: 'top_failure_reason', title: 'ä¸»è¦å¤±è´¥åŸå› ', width: 120},
                        {field: 'first_blocked', title: 'é¦–æ¬¡å±è”½', width: 170, templet: function(d){
                            return new Date(d.first_blocked).toLocaleString();
                        }},
                        {field: 'last_updated', title: 'æœ€åæ›´æ–°', width: 170, templet: function(d){
                            return new Date(d.last_updated).toLocaleString();
                        }},
                        {field: 'is_expired', title: 'çŠ¶æ€', width: 80, templet: function(d){
                            return d.is_expired ? '<span class="layui-badge layui-bg-gray">å·²è¿‡æœŸ</span>' :
                                   '<span class="layui-badge layui-bg-green">æ´»è·ƒ</span>';
                        }},
                        {field: 'ports', title: 'ç«¯å£', width: 150, templet: function(d){
                            if(!d.ports || d.ports.length === 0) return '-';
                            return d.ports.map(p => p.port).join(', ');
                        }}
                    ]],
                    page: true,
                    limit: 20,
                    limits: [10, 20, 50, 100],
                    size: 'sm'
                });
            }

            // æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…
            function showItemDetail(key) {
                var item = blacklistData.find(d => d.key === key);
                if(!item) return;

                var content = `
                    <div style="padding: 20px;">
                        <h3>${item.key}</h3>
                        <p><strong>ç±»å‹ï¼š</strong>${item.type}</p>
                        <p><strong>æ€»å°è¯•æ¬¡æ•°ï¼š</strong>${item.total_attempts}</p>
                        <p><strong>é¦–æ¬¡å±è”½ï¼š</strong>${new Date(item.first_blocked).toLocaleString()}</p>
                        <p><strong>æœ€åæ›´æ–°ï¼š</strong>${new Date(item.last_updated).toLocaleString()}</p>
                        <p><strong>çŠ¶æ€ï¼š</strong>${item.is_expired ? 'å·²è¿‡æœŸ' : 'æ´»è·ƒ'}</p>
                        ${item.ip_list && item.ip_list.length > 0 ? '<p><strong>IPåˆ—è¡¨ï¼š</strong>' + item.ip_list.join(', ') + '</p>' : ''}
                        ${item.failure_reasons_str ? '<p><strong>å¤±è´¥åŸå› ç»Ÿè®¡ï¼š</strong>' + JSON.stringify(item.failure_reasons_str) + '</p>' : ''}
                    </div>
                `;

                layer.open({
                    type: 1,
                    title: 'é»‘åå•é¡¹è¯¦æƒ…',
                    area: ['600px', '500px'],
                    content: content
                });
            }

            // äº‹ä»¶ç»‘å®š
            document.getElementById('refreshTable').onclick = function(){
                loadBlacklistList();
                layer.msg('åˆ·æ–°æˆåŠŸ');
            };

            document.getElementById('clearExpired').onclick = function(){
                layer.confirm('ç¡®è®¤æ¸…ç†æ‰€æœ‰å·²è¿‡æœŸçš„é»‘åå•é¡¹ï¼Ÿ', function(index){
                    // TODO: è°ƒç”¨æ¸…ç†API
                    layer.close(index);
                    layer.msg('æ¸…ç†åŠŸèƒ½å¾…å®ç°');
                });
            };
        });
    </script>
</body>
</html>