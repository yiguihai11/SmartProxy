<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Memory Monitor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .stat {
            display: inline-block;
            margin: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
        }
        .error {
            color: red;
            padding: 10px;
            background: #ffebee;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>SmartProxy 简易内存监控</h1>

    <div id="error" class="error" style="display: none;"></div>

    <div class="card">
        <h2>内存统计</h2>
        <div class="stat">已分配: <span id="allocated">-</span> MB</div>
        <div class="stat">活跃连接: <span id="active-conns">-</span></div>
        <div class="stat">UDP会话: <span id="udp-sessions">-</span></div>
        <div class="stat">DNS缓存: <span id="dns-cache">-</span></div>
    </div>

    <div class="card">
        <h2>缓冲区池</h2>
        <div class="stat">活跃对象: <span id="buf-active">-</span></div>
        <div class="stat">命中率: <span id="buf-hit">-</span></div>
        <div class="stat">总请求: <span id="buf-req">-</span></div>
        <div class="stat">内存使用: <span id="buf-mem">-</span> MB</div>
    </div>

    <div class="card">
        <h2>连接池</h2>
        <div class="stat">活跃对象: <span id="conn-active">-</span></div>
        <div class="stat">池中对象: <span id="conn-pooled">-</span></div>
        <div class="stat">已创建: <span id="conn-created">-</span></div>
        <div class="stat">总请求: <span id="conn-total">-</span></div>
    </div>

    <div class="card">
        <button onclick="loadData()">刷新数据</button>
        <button onclick="toggleAutoRefresh()">自动刷新: <span id="auto-status">关闭</span></button>
        <div>最后更新: <span id="last-update">-</span></div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let autoRefreshEnabled = false;

        // 显示错误
        function showError(msg) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // 加载数据
        async function loadData() {
            try {
                console.log('Loading data...');

                // 并行请求所有API
                const [statsRes, poolsRes] = await Promise.all([
                    fetch('/api/memory/stats'),
                    fetch('/api/memory/pools')
                ]);

                if (!statsRes.ok) throw new Error('Stats API failed: ' + statsRes.statusText);
                if (!poolsRes.ok) throw new Error('Pools API failed: ' + poolsRes.statusText);

                const statsData = await statsRes.json();
                const poolsData = await poolsRes.json();

                console.log('Stats:', statsData);
                console.log('Pools:', poolsData);

                // 更新内存统计
                if (statsData.success) {
                    const stats = statsData.data;
                    document.getElementById('allocated').textContent = (stats.alloc / 1024 / 1024).toFixed(2);
                    document.getElementById('active-conns').textContent = stats.active_connections || 0;
                    document.getElementById('udp-sessions').textContent = stats.active_udp_sessions || 0;
                    document.getElementById('dns-cache').textContent = stats.active_dns_cache || 0;
                }

                // 更新缓冲区池
                if (poolsData.success && poolsData.data.buffer_pool) {
                    const buf = poolsData.data.buffer_pool;
                    document.getElementById('buf-active').textContent = buf.active_objects || 0;
                    document.getElementById('buf-hit').textContent = (buf.hit_rate_percent || 0).toFixed(1) + '%';
                    document.getElementById('buf-req').textContent = (buf.total_requests || 0).toLocaleString();
                    document.getElementById('buf-mem').textContent = (buf.total_memory_mb || 0).toFixed(2);
                }

                // 更新连接池
                if (poolsData.success && poolsData.data.connection_pool) {
                    const conn = poolsData.data.connection_pool;
                    document.getElementById('conn-active').textContent = (conn.active_connections || 0).toLocaleString();
                    document.getElementById('conn-pooled').textContent = (conn.pooled_connections || 0).toLocaleString();
                    document.getElementById('conn-created').textContent = (conn.created_connections || 0).toLocaleString();
                    document.getElementById('conn-total').textContent = (conn.total_requests || 0).toLocaleString();
                }

                // 更新时间
                document.getElementById('last-update').textContent = new Date().toLocaleString();

            } catch (error) {
                console.error('Load data error:', error);
                showError('加载数据失败: ' + error.message);
            }
        }

        // 切换自动刷新
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const statusSpan = document.getElementById('auto-status');

            if (autoRefreshEnabled) {
                statusSpan.textContent = '开启';
                autoRefreshInterval = setInterval(loadData, 5000);
            } else {
                statusSpan.textContent = '关闭';
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        // 页面加载时自动加载一次数据
        window.addEventListener('load', function() {
            loadData();
        });
    </script>
</body>
</html>